/*!CK:568057411!*//*1408337192,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["cWVji"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNSENT:0,SUCCESS:1,UNCONFIRMED:3,FAILED_UNKNOWN_REASON:4,UNABLE_TO_CONFIRM:5,RESENT:6,RESENDING:7,ERROR:10};},null);
__d("MercuryActionTypeConstants",[],function(a,b,c,d,e,f){e.exports={LOG_MESSAGE:"ma-type:log-message",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings",CLEAR_CHAT:"ma-type:clear_chat",SEND_MESSAGE:"ma-type:send-message",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",DELETE_THREAD:"ma-type:delete-thread",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",CHANGE_FOLDER:"ma-type:change-folder"};},null);
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={CHAT:"chat",JEWEL:"jewel",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};},null);
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={PHOTO:"attach:image",VIDEO:"attach:video",MUSIC:"attach:music",VOICE:"attach:voice",TEXT:"attach:text",MSWORD:"attach:ms:word",MSXLS:"attach:ms:xls",MSPPT:"attach:ms:ppt",ORION:"attach:orion",UNKNOWN:"attach:unknown"};},null);
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={ERROR:"error",FILE:"file",PHOTO:"photo",STICKER:"sticker",SHARE:"share",VIDEO:"video"};},null);
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};},null);
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={PENDING_THREAD_ID:"pending:pending",MAX_THREAD_NAME_LENGTH:"250"};},null);
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};},null);
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SUBSCRIBE:"log:subscribe",UNSUBSCRIBE:"log:unsubscribe",VIDEO_CALL:"log:video-call",PHONE_CALL:"log:phone-call",THREAD_NAME:"log:thread-name",THREAD_IMAGE:"log:thread-image",SERVER_ERROR:"log:error-msg",LIVE_LISTEN:"log:live-listen",WALLPAPER:"log:wallpaper"};},null);
__d("MercuryMessageSourceTags",[],function(a,b,c,d,e,f){e.exports={CHAT:"source:chat",EMAIL:"source:email",MESSENGER:"source:messenger",MOBILE:"source:mobile"};},null);
__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){e.exports={USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page",FRIEND:"friend"};},null);
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"unknown",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",CLIENT_DELETE_MESSAGES:"client_delete_messages",CLIENT_DELETE_THREAD:"client_delete_thread",CLIENT_HANDLE_ERROR:"client_handle_error",SERVER_INITIAL_DATA:"server_initial_data",SERVER_SEND_MESSAGE:"server_send_message",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_MARK_SEEN:"server_mark_seen",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",SERVER_THREAD_SYNC:"server_thread_sync",SERVER_TAB_PRESENCE:"server_tab_presence",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_SEARCH:"server_search"};},null);
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={CHAT_ORCA:"source:chat:orca",CHAT_IPHONE:"source:chat:iphone",CHAT_JABBER:"source:chat:jabber",CHAT_MEEBO:"source:chat:meebo",CHAT_WEB:"source:chat:web",CHAT_TEST:"source:chat:test",CHAT:"source:chat",EMAIL:"source:email",GIGABOXX_API:"source:gigaboxx:api",GIGABOXX_BLAST:"source:gigaboxx:blast",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",GIGABOXX_MOBILE:"source:gigaboxx:mobile",GIGABOXX_WAP:"source:gigaboxx:wap",GIGABOXX_WEB:"source:gigaboxx:web",LEIA:"source:leia",SHARE_DIALOG:"source:share:dialog",SEND_PLUGIN:"source:sendplugin",SMS:"source:sms",TEST:"source:test",TITAN_WAP:"source:titan:wap",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_JAPAN:"source:titan:m_japan",TITAN_M_MINI:"source:titan:m_mini",TITAN_M_TOUCH:"source:titan:m_touch",TITAN_M_APP:"source:titan:m_app",TITAN_M_TABLET:"source:titan:m_tablet",TITAN_M_ZERO:"source:titan:m_zero",TITAN_M_TALK:"source:titan:m_talk",TITAN_WEB:"source:titan:web",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",TITAN_API:"source:titan:api",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_ORCA:"source:titan:orca",TITAN_EMAIL_REPLY:"source:titan:emailreply",MOBILE:"source:mobile",UNKNOWN:"source:unknown",WEB:"source:web",HELPCENTER:"source:helpcenter",NEW_SHARE_DIALOG:"source:share:dialog:new",PAID_PROMOTION:"source:paid_promotion",BUFFY_SMS:"source:buffy:sms",WEBRTC_MOBILE:"source:webrtc:mobile"};},null);
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,TITAN_ORIGINATED:2,OBJECT_ORIGINATED:3};},null);
__d("MercuryTimePassed",[],function(a,b,c,d,e,f){e.exports={TODAY:0,WEEK_AGO:1,MONTH_AGO:2,CURRENT_YEAR:3,OTHER_YEAR:4};},null);
__d("MessagingEvent",[],function(a,b,c,d,e,f){e.exports={DELETE:"delete",DELETE_MESSAGES:"delete_messages",DELIVER:"deliver",ERROR:"error",READ:"read",REPORT_SPAM:"report_spam",REPORT_SPAM_MESSAGES:"report_spam_messages",UNMARK_SPAM:"unmark_spam",SUBSCRIBE:"subscribe",CHANGE_MUTE_SETTINGS:"change_mute_settings",TAG:"tag",UNREAD:"unread",UNSUBSCRIBE:"unsubscribe",DELIVER_LOG:"deliver_log",MORE_THREADS:"more_threads",READ_ALL:"read_all",READ_RECEIPT:"read_receipt",DELIVERY_RECEIPT:"delivery_receipt",SENT_PUSH:"sent_push",DELIVER_FAST_PAST:"deliver_fast_path",MESSENGER_STATUS:"messenger_status",UPDATE_PINNED_THREADS:"update_pinned_threads"};},null);
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={GROUPS:"groups",UNREAD:"unread",ACTION_ARCHIVED:"action:archived",INBOX:"inbox",OTHER:"other",EVENT:"event",SENT:"sent",SMS_MUTE:"sms_mute",SPAM:"spam",UPDATES:"broadcasts_inbox",BCC:"header:bcc",FILTERED_CONTENT:"filtered_content",ARCHIVED:"archived",EMAIL:"email",VOICEMAIL:"voicemail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SMS_TAG_ROOT:"SMSShortcode:",APP_ID_ROOT:"app_id:",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",MTA_SYSTEM_MESSAGE:"MTA:system_message",EMAIL_MESSAGE:"source:email"};},null);
__d("PhotoResizeModeConst",[],function(a,b,c,d,e,f){e.exports={CONTAIN:"s",COVER:"p"};},null);
__d("requireWeak",[],function(a,b,c,d,e,f){function g(h,i){d.call(null,h,i);}e.exports=g;},null);
__d("ChatImpressionLogger",["AsyncSignal","requireWeak","ChatConfig","ChatVisibility","Poller","PresencePrivacy","PresenceStatus","debounceAcrossTransitions","copyProperties"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=null;h(['AvailableList'],function(v){return p=v;});var q=null;function r(){if(!q)return '';return q.getCachedSortedList().toString();}function s(){if(!q||!p)return '';var v=[],w=q.getCachedSortedList();for(var x=0;x<w.length;x++)v[x]=p.get(w[x]);return v.toString();}function t(v){v.setURI('/ajax/chat/imps_logging.php').setData({list_availability:s(),sorted_list:r(),source:'periodical_imps'});}var u={init:function(v){q=v;var w=i.get('chat_impression_logging_periodical',0);if(w){var x=i.get('periodical_impression_logging_config.interval'),y=new k({interval:x,setupRequest:t,clearOnQuicklingEvents:false,dontStart:true});l.subscribe('privacy-user-presence-changed',n(function(){if(j.isOnline()){y.start();}else y.stop();}));}this.init=function(){};},logImpression:function(v,w,x){var y=i.get('chat_impression_logging_with_click'),z={list_availability:y?s():'',sorted_list:y?r():'',source:v,target:w,target_presence:m.get(w),viewport_width:document.body.clientWidth};new g('/ajax/chat/ct.php',o(z,x)).send();}};e.exports=u;},null);
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f,g,h){var i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;},null);
__d("MercuryIDs",[],function(a,b,c,d,e,f){var g={isValid:function(h){if(!h||typeof h!=='string')return false;return (/^\w{3,12}:/.test(h));},isValidThreadID:function(h){if(!g.isValid(h))return false;var i=g.tokenize(h);switch(i.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(h){if(!this.isValid(h))throw 'bad_id_format';var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};},getUserIDFromParticipantID:function(h){if(!g.isValid(h))return null;var i=g.tokenize(h);if(i.type!='fbid')return null;return i.value;},isMultichat:function(h){return this.isValid(h)&&this.tokenize(h).type!=='user';}};e.exports=g;},null);
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f,g){e.exports={isParticipantID:function(h){if(!g.isValid(h))throw ("bad_participant_id "+h);},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw ("bad_user_id "+h);},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw ("bad_email_id "+h);},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw ("bad_thread_id "+h);}};},null);
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f,g,h,i){var j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';case g.ORION:return 'MercuryOrionIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';l.push(p);}}return l;},get:function(k){var l=[];if(k.attachments){l=k.attachments;}else if(k.raw_attachments)l=this.convertRaw(k.raw_attachments);if(!(k.attachments&&k.attachments.length>0)&&k.preview_attachments&&k.preview_attachments.length>0)return l.concat(k.preview_attachments);return l;}};e.exports=j;},null);
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f,g){var h={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(g.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=h;},null);
__d("ImageSourceType",[],function(a,b,c,d,e,f){var g={PROFILE_PICTURE:'profile_picture',IMAGE:'image'};e.exports=g;},null);
__d("ImageSourceRequest",["CurrentUser","ImageSourceType","KeyedCallbackManager","PhotoResizeModeConst","MercuryServerDispatcher","arrayContains","extendArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){"use strict";this._request={fbid:null,type:null,width:null,height:null,resize_mode:null};this._callback=null;}n.prototype.setFBID=function(r){"use strict";this._request.fbid=r;return this;};n.prototype.setType=function(r){"use strict";if(!l([h.PROFILE_PICTURE,h.IMAGE],r))throw new TypeError('ImageSourceRequest.setType: invalid type '+r);this._request.type=r;return this;};n.prototype.setDimensions=function(r,s){"use strict";this._request.width=r;this._request.height=s;return this;};n.prototype.setResizeMode=function(r){"use strict";if(!l([j.COVER,j.CONTAIN],r))throw new TypeError('ImageSourceRequest.setResizeMode: invalid resize mode '+r);this._request.resize_mode=r;return this;};n.prototype.setCallback=function(r){"use strict";this._callback=r;return this;};n.prototype.send=function(){"use strict";if(!this._request.fbid||!this._request.width||!this._request.height||!this._request.type||!this._request.resize_mode||!this._callback)throw new Error('ImageSourceRequest: You must set all the fields');var r=p(),s=q(this._request);r.executeOrEnqueue(s,this._callback);if(r.getUnavailableResourcesFromRequest(s).length===1){k.trySend('/ajax/image_source.php',{requests:[this._request]});return true;}return false;};var o=null;function p(){if(o)return o;var r=new i();o=r;k.registerEndpoints({'/ajax/image_source.php':{request_user_id:g.getID(),mode:k.BATCH_DEFERRED_MULTI,batch_function:function(s,t){m(s.requests,t.requests);return s;},handler:function(s,t){var u=t.getData().requests;for(var v=0;v<u.length;++v)r.setResource(q(u[v]),s[v]);}}});return r;}function q(r){return [r.fbid,r.type,r.width,r.height,r.resize_mode].join('|');}e.exports=n;},null);
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;},null);
__d("XMercurySendLogControllerURIBuilder",["XControllerURIBuilder"],function(a,b,c,d,e,f){e.exports=b("XControllerURIBuilder").create("\/messaging\/send_logger\/",{message_id:{type:"String",required:true},event:{type:"Enum",required:true},is_canonical:{type:"Bool"}});},null);
__d("MercurySendLogger",["AsyncSignal","XMercurySendLogControllerURIBuilder"],function(a,b,c,d,e,f,g,h){var i=false,j={CLIENT_SEND_ATTEMPTED:'client_send_attempted',CLIENT_RESEND_ATTEMPTED:'client_resend_attempted',CLIENT_SEND_SUCCEEDED:'client_send_succeeded',CLIENT_SEND_FAILED:'client_send_failed',CLIENT_CHANNEL_ECHO:'client_channel_echo',enable:function(){i=true;},log:function(event,k,l){if(!i)return;new g((new h()).setEnum('event',event).setString('message_id',k).setBool('is_canonical',!!l.canonical).getURI().toString()).send();}};e.exports=j;},null);
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f,g){var h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;},null);
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k){var l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;},null);
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f,g,h,i,j){function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};this.updatedThread(m);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;},null);
__d("MercuryServerRequests",["Arbiter","ArbiterMixin","AsyncResponse","BanzaiLogger","ChannelConstants","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionTypeConstants","MercuryAPIArgsSource","MercuryAssert","MercuryConfig","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLoggingHelper","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendLogger","MercuryServerRequestsConfig","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa){"use strict";var pa=n.getInstance('mercury_server'),qa=q.MERCURY;function ra(jc,kc){if(kc)jc._lastActionTimestamp=Math.max(jc._lastActionTimestamp,kc);}function sa(jc,kc){var lc=kc.thread_id,mc=jc._serverToClientIDs.getResource(lc);if(!mc){if(kc.canonical_fbid){mc='user:'+kc.canonical_fbid;}else if(kc.root_message_threading_id)mc='root:'+kc.root_message_threading_id;mc=mc||'thread:'+lc;ua(jc,lc,mc);}kc.thread_id=mc;}function ta(jc,kc){var lc=kc.thread_fbid;if(kc.canonical_fbid)lc=kc.canonical_fbid;var mc=jc._FBIDToClientIDs.getResource(lc);if(!mc){if(kc.canonical_fbid){mc='user:'+kc.canonical_fbid;}else if(kc.root_message_threading_id)mc='root:'+kc.root_message_threading_id;mc=mc||'thread:'+lc;if(lc)lc=lc.toString();va(jc,lc,mc);if(kc.thread_id)ua(jc,kc.thread_id,mc);}kc.thread_id=mc;}function ua(jc,kc,lc){jc._serverToClientIDs.setResource(kc,lc);jc._clientToServerIDs.setResource(lc,kc);jc._newlyAddedClientIDs[kc]=lc;}function va(jc,kc,lc){jc._clientIDToFBIDs.setResource(lc,kc);jc._FBIDToClientIDs.setResource(kc,lc);jc._newlyAddedClientIDs[kc]=lc;}function wa(jc,kc,lc){var mc=jc._clientToServerIDs.executeOrEnqueue(kc,lc),nc=jc._clientToServerIDs.getUnavailableResources(mc),oc=jc.tokenizeThreadID(kc);if(nc.length&&oc.type!='root')jc.fetchThreadData(nc);}function xa(jc,kc,lc){var mc=jc._clientIDToFBIDs.executeOrEnqueue(kc,lc),nc=jc._clientIDToFBIDs.getUnavailableResources(mc),oc=jc.tokenizeThreadID(kc);if(nc.length&&oc.type!='root')jc.fetchThreadData(nc);}function ya(jc,kc){return jc._clientToServerIDs.getResource(kc);}function za(jc,kc){return jc._clientIDToFBIDs.getResource(kc);}function ab(jc,kc){return !!jc._serverToClientIDs.getResource(kc);}function bb(jc,kc){return !!jc._FBIDToClientIDs.getResource(kc);}function cb(jc,kc){var lc=jc._serverToClientIDs.getResource(kc);if(typeof lc=='undefined')pa.warn('no_client_thread_id',{server_id:kc});return lc;}function db(jc,kc){var lc=jc._FBIDToClientIDs.getResource(kc);if(typeof lc=='undefined')pa.warn('no_client_thread_id',{thread_fbid:kc});return lc;}function eb(jc,kc,lc){jc._serverToClientIDs.executeOrEnqueue(kc,lc);jc.ensureThreadIsFetched(kc);}function fb(jc,kc,lc){jc._FBIDToClientIDs.executeOrEnqueue(kc,lc);jc.ensureThreadIsFetched(kc);}function gb(jc,kc,lc){if(kc.action_type!=p.SEND_MESSAGE)return;var mc=kc.client_thread_id;if(!mc)mc=cb(jc,kc.thread_id);var nc=null;if(mc)nc=w.tokenize(mc).type;jb(jc,kc,lc==='success');ia.addEntry('send_'+nc,lc,kc.thread_id+','+kc.message_id);ba.log(lc==='success'?ba.CLIENT_SEND_SUCCEEDED:ba.CLIENT_SEND_FAILED,kc.client_message_id,{canonical:nc&&!w.isMultichat(mc)});}function hb(jc,kc,lc){if(kc.action_type!=p.SEND_MESSAGE)return;var mc=kc.thread_fbid;if(kc.other_user_fbid)mc=kc.other_user_fbid;var nc=kc.client_thread_id;if(!nc)nc=db(jc,mc);var oc=null;if(nc)oc=w.tokenize(nc).type;jb(jc,kc,lc==='success');ia.addEntry('send_'+oc,lc,mc+','+kc.message_id);ba.log(lc==='success'?ba.CLIENT_SEND_SUCCEEDED:ba.CLIENT_SEND_FAILED,kc.client_message_id,{canonical:oc&&!w.isMultichat(nc)});}function ib(jc){return jc.getError()?'_'+jc.getError():'';}function jb(jc,kc,lc){if(Math.floor(Math.random()*20)===0)if(kc.client_message_id in jc._sentMessagesTimestamp){var mc=jc._sentMessagesTimestamp[kc.client_message_id],nc=Date.now()-mc,oc=kc.client_thread_id;if(!oc)if(s.MercuryFBIDGK){oc=db(jc,kc.thread_fbid);}else oc=cb(jc,kc.thread_id);j.log('WebMessagingLatencyLoggerConfig',{has_attachment:kc.attachments&&kc.attachments.length>0,latency:nc,is_canonical:!w.isMultichat(oc),send_successful:lc,source:'client'});}}function kb(jc,kc){var lc=null;switch(kc.status){case o.SUCCESS:lc='success';break;case o.FAILED_UNKNOWN_REASON:lc='confirmed_error';break;case o.UNABLE_TO_CONFIRM:lc='confirm_error';break;default:return;}if(s.MercuryFBIDGK){hb(jc,kc,lc);}else gb(jc,kc,lc);}function lb(jc,kc){(kc.message_counts||[]).forEach(function(tc){ra(jc,tc.seen_timestamp);});(kc.threads||[]).forEach(function(tc){sa(jc,tc);delete jc._fetchingThreads[tc.thread_id];var uc=ya(jc,tc.thread_id);delete jc._fetchingThreads[uc];ra(jc,tc.timestamp);});(kc.ordered_threadlists||[]).forEach(function(tc){tc.thread_ids=tc.thread_ids.map(cb.bind(null,jc));});kc.actions=kc.actions||[];kc.actions.forEach(function(tc){kb(jc,tc);if(tc.status&&tc.status!=o.SUCCESS&&!tc.thread_id){tc.thread_id=tc.client_thread_id;return;}if(tc.action_type==p.SEND_MESSAGE&&tc.client_thread_id&&tc.client_thread_id!=u.PENDING_THREAD_ID&&tc.thread_id)ua(jc,tc.thread_id,tc.client_thread_id);tc.server_thread_id=tc.thread_id;if(tc.thread_id){tc.thread_id=ab(jc,tc.thread_id)?cb(jc,tc.thread_id):null;}else if(tc.client_thread_id)tc.thread_id=tc.client_thread_id;ra(jc,tc.timestamp);});if(kc.end_of_history){var lc=[];for(var mc=0;mc<kc.end_of_history.length;mc++){var nc=kc.end_of_history[mc];if(nc.type=='user'){lc.push('user:'+nc.id);}else if(nc.type=='thread'&&ab(jc,nc.id))lc.push(cb(jc,nc.id));}kc.end_of_history=lc;}if(kc.roger){var oc={};for(var pc in kc.roger){var qc=jc._serverToClientIDs.getResource(pc);if(qc){var rc=kc.roger[pc];oc[qc]={};for(var sc in rc)oc[qc]['fbid:'+sc]=rc[sc];}}kc.roger=oc;}}function mb(jc,kc){(kc.threads||[]).forEach(function(tc){ta(jc,tc);delete jc._fetchingThreads[tc.thread_id];var uc=za(jc,tc.thread_id);delete jc._fetchingThreads[uc];ra(jc,tc.timestamp);});(kc.ordered_threadlists||[]).forEach(function(tc){var uc=tc.thread_fbids||[];uc=uc.concat(tc.other_user_fbids||[]);tc.thread_ids=uc.map(db.bind(null,jc));});kc.actions=kc.actions||[];kc.actions.forEach(function(tc){kb(jc,tc);var uc=tc.thread_fbid;if(tc.other_user_fbid)uc=tc.other_user_fbid;if(tc.status&&tc.status!=o.SUCCESS&&!uc){tc.thread_id=tc.client_thread_id;return;}if(tc.action_type==p.SEND_MESSAGE&&tc.client_thread_id&&tc.client_thread_id!=u.PENDING_THREAD_ID&&uc)va(jc,uc.toString(),tc.client_thread_id);var vc=tc.thread_id;if(uc){tc.thread_id=bb(jc,uc)?db(jc,uc):null;}else if(tc.client_thread_id)tc.thread_id=tc.client_thread_id;if(!tc.thread_id)tc.server_thread_id=vc;ra(jc,tc.timestamp);});if(kc.end_of_history){var lc=[];for(var mc=0;mc<kc.end_of_history.length;mc++){var nc=kc.end_of_history[mc];if(nc.type=='user'){lc.push('user:'+nc.fbid);}else if(nc.type=='thread'&&bb(jc,nc.fbid))lc.push(db(jc,nc.fbid));}kc.end_of_history=lc;}if(kc.roger){var oc={};for(var pc in kc.roger){var qc=jc._serverToClientIDs.getResource(pc);if(qc){var rc=kc.roger[pc];oc[qc]={};for(var sc in rc)oc[qc]['fbid:'+sc]=rc[sc];}}kc.roger=oc;}}function nb(jc){if(jc._pendingUpdates&&jc._pendingUpdates.length){var kc=jc._pendingUpdates[0];jc._pendingUpdates=jc._pendingUpdates.slice(1);jc.handleUpdate(kc);}}function ob(jc,kc){var lc=ma({},jc),mc;if(kc.threads){if(!lc.threads)lc.threads={};for(mc in kc.threads)lc.threads[mc]=Object.keys(na((lc.threads[mc]||[]).concat(kc.threads[mc])));}if(kc.messages){if(!lc.messages)lc.messages={};for(mc in kc.messages){if(!lc.messages[mc])lc.messages[mc]={};for(var nc in kc.messages[mc])if(lc.messages[mc][nc]){lc.messages[mc][nc]=rb(lc.messages[mc][nc],kc.messages[mc][nc]);}else lc.messages[mc][nc]=kc.messages[mc][nc];}}lc.client=jc.client||kc.client;return lc;}function pb(jc,kc){var lc=ma(na(jc.folders,true),na(kc.folders,true)),mc=jc.client||kc.client;return {folders:Object.keys(lc),client:mc};}function qb(jc,kc){for(var lc in kc)if(jc[lc]&&typeof jc[lc]==='object'){jc[lc]=rb(jc[lc],kc[lc]);}else if(kc[lc]&&typeof kc[lc]==='object'){var mc={};ma(mc,kc[lc]);jc[lc]=mc;}return jc;}function rb(jc,kc){var lc=jc.offset<kc.offset?jc.offset:kc.offset,mc=jc.offset+jc.limit,nc=kc.offset+kc.limit,oc=(mc>nc)?mc:nc,pc=oc-lc;return {offset:lc,limit:pc};}function sb(jc,kc){var lc=jc.client||kc.client,mc={ids:{},client:lc};ma(mc.ids,jc.ids);ma(mc.ids,kc.ids);return mc;}function tb(jc,kc){var lc={},mc,nc=jc.client||kc.client;delete jc.client;delete kc.client;for(mc in jc)ma(lc,na(jc[mc],mc));for(mc in kc)ma(lc,na(kc[mc],mc));var oc={client:nc};for(var pc in lc){mc=lc[pc];if(!oc[mc])oc[mc]=[];oc[mc].push(pc);}return oc;}function ub(jc,kc){var lc=jc.client||kc.client,mc=na(jc.ids,true),nc=na(kc.ids,true),oc=ma(mc,nc);return {ids:Object.keys(oc),client:lc};}function vb(jc){this._fbid=jc;this._lastActionTimestamp=0;this._serverToClientIDs=new m();this._clientToServerIDs=new m();this._FBIDToClientIDs=new m();this._clientIDToFBIDs=new m();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};this._sentMessagesTimestamp={};hc(this);}ma(vb.prototype,h,{tokenizeThreadID:function(jc){r.isThreadID(jc);return w.tokenize(jc);},getServerThreadID:function(jc,kc){r.isThreadID(jc);if(s.MercuryFBIDGK){xa(this,jc,kc);}else wa(this,jc,kc);},getThreadFBID:function(jc,kc){r.isThreadID(jc);xa(this,jc,kc);},getClientThreadID:function(jc,kc){if(s.MercuryFBIDGK){fb(this,jc,kc);}else eb(this,jc,kc);},getClientThreadIDNow:function(jc){if(s.MercuryFBIDGK){return db(this,jc);}else return cb(this,jc);},getServerThreadIDNow:function(jc){if(s.MercuryFBIDGK){return za(this,jc);}else return ya(this,jc);},getClientThreadIDForPermalinks:function(jc){return cb(this,jc);},convertThreadIDIfAvailable:function(jc){var kc;if(s.MercuryFBIDGK){kc=this._FBIDToClientIDs.getResource(jc);if(kc===undefined){return jc;}else return kc;}else{kc=this._serverToClientIDs.getResource(jc);if(kc===undefined){return jc;}else return kc;}},isUser:function(jc){return jc<2.2e+09||(jc>=1e+14&&jc<=100099999989999)||(jc>=8.9e+13&&jc<=89999999999999);},canLinkExternallyThreadID:function(jc){r.isThreadID(jc);var kc=this.tokenizeThreadID(jc);return (kc.type=='user')||!!ya(this,jc);},canLinkExternallyFBID:function(jc){r.isThreadID(jc);var kc=this.tokenizeThreadID(jc);return (kc.type=='user')||!!za(this,jc);},canLinkExternally:function(jc){if(s.MercuryFBIDGK){return this.canLinkExternallyFBID(jc);}else return this.canLinkExternallyThreadID(jc);},fetchThreadlistInfo:function(jc,kc,lc,mc,nc){lc=lc||ja.INBOX;nc=nc||qa;var oc=mc?ka.IMMEDIATE:null,pc={client:nc};pc[lc]={offset:jc,limit:kc,filter:mc};ic(this,'/ajax/mercury/threadlist_info.php',pc,oc);},fetchUnseenThreadIDs:function(jc,kc){kc=kc||qa;this.fetchThreadlistInfo(fa.RECENT_THREAD_OFFSET,fa.JEWEL_THREAD_COUNT,jc,null,kc);},fetchUnreadThreadIDs:function(jc,kc){kc=kc||qa;ic(this,'/ajax/mercury/unread_threads.php',{folders:[jc],client:kc});},fetchMissedMessages:function(jc,kc){kc=kc||qa;var lc={last_action_timestamp:this._lastActionTimestamp,folders:jc,client:kc};lc.last_action_timestamp=this._lastActionTimestamp;ic(this,'/ajax/mercury/thread_sync.php',lc);},fetchThreadData:function(jc,kc){if(s.MercuryFBIDGK){this.fetchThreadDataFBID(jc,kc);}else this.fetchThreadDataThreadID(jc,kc);},fetchThreadDataThreadID:function(jc,kc){kc=kc||qa;r.allThreadID(jc);var lc={threads:{},client:kc},mc=[],nc=[];jc.forEach(function(pc){if(this._fetchingThreads[pc])return;this._fetchingThreads[pc]=true;var qc=ya(this,pc);if(qc){nc.push(qc);lc.threads.thread_ids=nc;}else{var rc=this.tokenizeThreadID(pc);if(rc.type=='user'){mc.push(rc.value);lc.threads.user_ids=mc;}else if(rc.type=='thread'){nc.push(rc.value);lc.threads.thread_ids=nc;}else if(rc.type!='root'&&rc.type!='pending')throw new Error('Unknown thread type',rc);}}.bind(this));this.inform("fetch-thread-data",lc);for(var oc in lc.threads){ic(this,'/ajax/mercury/thread_info.php',lc);break;}},fetchThreadDataFBID:function(jc,kc){kc=kc||qa;r.allThreadID(jc);var lc={threads:{},client:kc},mc=[],nc=[];jc.forEach(function(pc){if(this._fetchingThreads[pc])return;this._fetchingThreads[pc]=true;var qc=za(this,pc),rc=this.tokenizeThreadID(pc);if(rc.type=='user'){mc.push(rc.value);lc.threads.user_ids=mc;}else if(rc.type=='thread'){if(qc){nc.push(qc);}else nc.push(rc.value);lc.threads.thread_fbids=nc;}else if(rc.type!='root'&&rc.type!='pending')throw new Error('Unknown thread type',rc);}.bind(this));this.inform("fetch-thread-data",lc);for(var oc in lc.threads){ic(this,'/ajax/mercury/thread_info.php',lc);break;}},ensureThreadIsFetched:function(jc,kc){if(s.MercuryFBIDGK){this.ensureThreadIsFetchedFBID(jc,kc);}else this.ensureThreadIsFetchedThreadID(jc,kc);},ensureThreadIsFetchedThreadID:function(jc,kc){kc=kc||qa;if(!this._serverToClientIDs.getResource(jc)&&!this._fetchingThreads[jc]){this._fetchingThreads[jc]=true;ic(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[jc]},client:kc});}},ensureThreadIsFetchedFBID:function(jc,kc){kc=kc||qa;if(!this._FBIDToClientIDs.getResource(jc)&&!this._fetchingThreads[jc]){this._fetchingThreads[jc]=true;ic(this,'/ajax/mercury/thread_info.php',{threads:{thread_fbids:[jc]},client:kc});}},fetchThreadMessages:function(jc,kc,lc,mc,nc){if(s.MercuryFBIDGK){this.fetchThreadMessagesFBID(jc,kc,lc,mc,nc);}else this.fetchThreadMessagesThreadID(jc,kc,lc,mc,nc);},fetchThreadMessagesThreadID:function(jc,kc,lc,mc,nc){r.isThreadID(jc);nc=nc||qa;var oc,pc,qc=this.tokenizeThreadID(jc),rc=ya(this,jc),sc=false;if(rc){pc='thread_ids';oc=rc;}else{oc=qc.value;switch(qc.type){case 'user':pc='user_ids';sc=true;break;case 'thread':pc='thread_ids';break;}}var tc={messages:{},threads:{},client:nc};if(pc){tc.messages[pc]={};tc.messages[pc][oc]={offset:kc,limit:lc};if(sc)tc.threads[pc]=[oc];ic(this,'/ajax/mercury/thread_info.php',tc,mc);}else wa(this,jc,function(uc){tc.messages.thread_ids={};tc.messages.thread_ids[uc]={offset:kc,limit:lc};ic(this,'/ajax/mercury/thread_info.php',tc,mc);}.bind(this));},fetchThreadMessagesFBID:function(jc,kc,lc,mc,nc){r.isThreadID(jc);nc=nc||qa;var oc,pc,qc=this.tokenizeThreadID(jc),rc=za(this,jc),sc=false;if(rc){oc=rc;pc=(qc.type=='user')?'user_ids':'thread_fbids';}else{oc=qc.value;switch(qc.type){case 'user':pc='user_ids';sc=true;break;case 'thread':pc='thread_fbids';break;}}var tc={messages:{},threads:{},client:nc};if(pc){tc.messages[pc]={};tc.messages[pc][oc]={offset:kc,limit:lc};if(sc)tc.threads[pc]=[oc];ic(this,'/ajax/mercury/thread_info.php',tc,mc);}else xa(this,jc,function(uc){tc.messages.thread_fbids={};tc.messages.thread_fbids[uc]={offset:kc,limit:lc};ic(this,'/ajax/mercury/thread_info.php',tc,mc);}.bind(this));},handleThreadInfoError:function(jc){if(s.MercuryFBIDGK){this.handleThreadInfoErrorFBID(jc);}else this.handleThreadInfoErrorThreadID(jc);},handleThreadInfoErrorThreadID:function(jc){var kc=jc.getRequest().getData(),lc=[];if(kc.messages){for(var mc in kc.messages.thread_ids)lc.push(wb(cb(this,mc)));for(var nc in kc.messages.user_ids)lc.push(wb('user:'+nc));for(var oc in kc.messages.group_ids)lc.push(wb('group:'+oc));}if(lc.length)this.handleUpdate({actions:lc,from_client:true,payload_source:aa.CLIENT_CHANNEL_MESSAGE});if(kc.threads&&(kc.threads.user_ids||kc.threads.group_ids||kc.threads.thread_ids)){var pc=5,qc=true;if(!kc.retry_count){kc.retry_count=0;if(kc.messages)delete kc.messages;}else if(kc.retry_count>=pc){qc=false;(kc.threads.thread_ids||[]).forEach(function(sc){if(sc in this._fetchingThreads)delete this._fetchingThreads[sc];}.bind(this));}if(qc){var rc=kc.retry_count*1000;oa(function(){pa.log('retry_thread',kc);ic(this,'/ajax/mercury/thread_info.php',kc);}.bind(this),rc);kc.retry_count++;}}},handleThreadInfoErrorFBID:function(jc){var kc=jc.getRequest().getData(),lc=[];if(kc.messages){for(var mc in kc.messages.thread_fbids)lc.push(wb(db(this,mc)));for(var nc in kc.messages.user_ids)lc.push(wb('user:'+nc));for(var oc in kc.messages.group_ids)lc.push(wb('group:'+oc));}if(lc.length)this.handleUpdate({actions:lc,from_client:true,payload_source:aa.CLIENT_CHANNEL_MESSAGE});if(kc.threads&&(kc.threads.user_ids||kc.threads.group_ids||kc.threads.thread_ids)){var pc=5,qc=true;if(!kc.retry_count){kc.retry_count=0;if(kc.messages)delete kc.messages;}else if(kc.retry_count>=pc){qc=false;(kc.threads.thread_ids||[]).forEach(function(sc){if(sc in this._fetchingThreads)delete this._fetchingThreads[sc];}.bind(this));}if(qc){var rc=kc.retry_count*1000;oa(function(){pa.log('retry_thread',kc);ic(this,'/ajax/mercury/thread_info.php',kc);}.bind(this),rc);kc.retry_count++;}}},markFolderAsRead:function(jc){ic(this,'/ajax/mercury/mark_folder_as_read.php',{folder:jc});var kc=[{action_type:v.MARK_ALL_READ,action_id:null,folder:jc}];this.handleUpdate({global_actions:kc,from_client:true,payload_source:aa.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(jc,kc,lc){if(s.MercuryFBIDGK){this.changeThreadReadStatusFBID(jc,kc,lc);}else this.changeThreadReadStatusThreadID(jc,kc,lc);},changeThreadReadStatusThreadID:function(jc,kc,lc){r.isThreadID(jc);wa(this,jc,function(nc){var oc={ids:{}};oc.ids[nc]=kc;ic(this,'/ajax/mercury/change_read_status.php',oc);}.bind(this));var mc=[{action_type:p.CHANGE_READ_STATUS,action_id:null,thread_id:jc,mark_as_read:kc,folder:lc}];this.handleUpdate({actions:mc,from_client:true,payload_source:aa.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatusFBID:function(jc,kc,lc){r.isThreadID(jc);xa(this,jc,function(nc){var oc={ids:{}};oc.ids[nc]=kc;ic(this,'/ajax/mercury/change_read_status.php',oc);}.bind(this));var mc=[{action_type:p.CHANGE_READ_STATUS,action_id:null,thread_id:jc,mark_as_read:kc,folder:lc}];this.handleUpdate({actions:mc,from_client:true,payload_source:aa.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(jc,kc){if(s.MercuryFBIDGK){this.changeThreadArchivedStatusFBID(jc,kc);}else this.changeThreadArchivedStatusThreadID(jc,kc);},changeThreadArchivedStatusThreadID:function(jc,kc){r.isThreadID(jc);wa(this,jc,function(nc){var oc={ids:{}};oc.ids[nc]=kc;ic(this,'/ajax/mercury/change_archived_status.php',oc);}.bind(this));var lc={action_type:p.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:jc,archived:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(mc);},changeThreadArchivedStatusFBID:function(jc,kc){r.isThreadID(jc);xa(this,jc,function(nc){var oc={ids:{}};oc.ids[nc]=kc;ic(this,'/ajax/mercury/change_archived_status.php',oc);}.bind(this));var lc={action_type:p.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:jc,archived:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(mc);},changeThreadFolder:function(jc,kc){if(s.MercuryFBIDGK){this.changeThreadFolderFBID(jc,kc);}else this.changeThreadFolderThreadID(jc,kc);},changeThreadFolderThreadID:function(jc,kc){r.isThreadID(jc);wa(this,jc,function(nc){var oc={};oc[kc]=[nc];ic(this,'/ajax/mercury/move_thread.php',oc);}.bind(this));var lc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(mc);},changeThreadFolderFBID:function(jc,kc){r.isThreadID(jc);xa(this,jc,function(nc){var oc={};oc[kc]=[nc];ic(this,'/ajax/mercury/move_thread.php',oc);}.bind(this));var lc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(mc);},changeMutingOnThread:function(jc,kc){if(s.ActionFBIDGK){this.changeMutingOnThreadFBID(jc,kc);}else this.changeMutingOnThreadThreadID(jc,kc);},changeMutingOnThreadThreadID:function(jc,kc){r.isThreadID(jc);wa(this,jc,function(nc){ic(this,'/ajax/mercury/change_mute_thread.php',{thread_id:nc,mute_settings:kc,payload_source:qa});}.bind(this));var lc={action_type:p.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:jc,mute_settings:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(mc);},changeMutingOnThreadFBID:function(jc,kc){r.isThreadID(jc);xa(this,jc,function(nc){ic(this,'/ajax/mercury/change_mute_thread.php',{thread_fbid:nc,mute_settings:kc,payload_source:qa});}.bind(this));var lc={action_type:p.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:jc,mute_settings:kc},mc={actions:[lc],from_client:true,payload_source:aa.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(mc);},markThreadSpam:function(jc){if(s.MercuryFBIDGK){this.markThreadSpamFBID(jc);}else this.markThreadSpamThreadID(jc);},markThreadSpamThreadID:function(jc){r.isThreadID(jc);wa(this,jc,function(mc){ic(this,'/ajax/mercury/mark_spam.php',{id:mc});}.bind(this));var kc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:ja.SPAM},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(lc);},markThreadSpamFBID:function(jc){r.isThreadID(jc);xa(this,jc,function(mc){ic(this,'/ajax/mercury/mark_spam.php',{id:mc});}.bind(this));var kc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:ja.SPAM},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(lc);},markMessagesSpam:function(jc,kc){ga.getServerIDs(kc||[],function(mc){ic(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:mc});}.bind(this));var lc={action_type:p.DELETE_MESSAGES,action_id:null,thread_id:jc,message_ids:kc};this.handleUpdate({actions:[lc],from_client:true,payload_source:aa.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(jc){if(s.MercuryFBIDGK){this.unmarkThreadSpamFBID(jc);}else this.unmarkThreadSpamThreadID(jc);},unmarkThreadSpamThreadID:function(jc){r.isThreadID(jc);wa(this,jc,function(mc){ic(this,'/ajax/mercury/unmark_spam.php',{id:mc});}.bind(this));var kc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:ja.INBOX},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(lc);},unmarkThreadSpamFBID:function(jc){r.isThreadID(jc);xa(this,jc,function(mc){ic(this,'/ajax/mercury/unmark_spam.php',{id:mc});}.bind(this));var kc={action_type:p.CHANGE_FOLDER,action_id:null,thread_id:jc,new_folder:ja.INBOX},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_CHANGE_FOLDER};this.handleUpdate(lc);},deleteThread:function(jc){if(s.MercuryFBIDGK){this.deleteThreadFBID(jc);}else this.deleteThreadThreadID(jc);},deleteThreadThreadID:function(jc){r.isThreadID(jc);wa(this,jc,function(mc){var nc={ids:[mc]};ic(this,'/ajax/mercury/delete_thread.php',nc);}.bind(this));var kc={action_type:p.DELETE_THREAD,action_id:null,thread_id:jc},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_DELETE_THREAD};this.handleUpdate(lc);},deleteThreadFBID:function(jc){r.isThreadID(jc);xa(this,jc,function(mc){var nc={ids:[mc]};ic(this,'/ajax/mercury/delete_thread.php',nc);}.bind(this));var kc={action_type:p.DELETE_THREAD,action_id:null,thread_id:jc},lc={actions:[kc],from_client:true,payload_source:aa.CLIENT_DELETE_THREAD};this.handleUpdate(lc);},deleteMessages:function(jc,kc,lc){ga.getServerIDs(kc||[],function(nc){ic(this,'/ajax/mercury/delete_messages.php',{message_ids:nc});}.bind(this));var mc;if(lc){mc={action_type:p.DELETE_THREAD,action_id:null,thread_id:jc};}else mc={action_type:p.DELETE_MESSAGES,action_id:null,thread_id:jc,message_ids:kc};this.handleUpdate({actions:[mc],from_client:true,payload_source:aa.CLIENT_DELETE_MESSAGES});},clearChat:function(jc,kc,lc){r.isThreadID(jc);ic(this,'/ajax/chat/settings.php',{clear_history_id:kc});var mc=[{action_type:p.CLEAR_CHAT,action_id:null,thread_id:jc,clear_time:lc}];this.handleUpdate({actions:mc,from_client:true,payload_source:aa.CLIENT_CLEAR_CHAT});},sendNewMessage:function(jc,kc){if(s.MercuryFBIDGK){this.sendNewMessageFBID(jc,kc);}else this.sendNewMessageThreadID(jc,kc);},sendNewMessageThreadID:function(jc,kc){kc=kc||qa;if(!jc.client_state||jc.client_state==z.SEND_TO_SERVER)ga.getServerIDs(jc.forward_message_ids||[],function(mc){var nc=jc.thread_id,oc=this.tokenizeThreadID(jc.thread_id),pc=oc.type,qc=ma({},jc);qc.forward_message_ids=mc;if((pc=='root'&&oc.value==qc.message_id)||(pc=='user'&&!ya(this,nc))||(jc.thread_id==u.PENDING_THREAD_ID)){qc.client_thread_id=qc.thread_id;qc.thread_id=null;this._sendNewMessageToServer(qc,kc);}else wa(this,qc.thread_id,function(rc){qc.thread_id=rc;this._sendNewMessageToServer(qc);}.bind(this));}.bind(this));if(jc.thread_id!=u.PENDING_THREAD_ID){var lc={actions:[ma({},jc)],from_client:true,payload_source:aa.CLIENT_SEND_MESSAGE};this.handleUpdate(lc);}},sendNewMessageFBID:function(jc,kc){kc=kc||qa;if(!jc.client_state||jc.client_state==z.SEND_TO_SERVER)ga.getServerIDs(jc.forward_message_ids||[],function(mc){var nc=jc.thread_id,oc=this.tokenizeThreadID(jc.thread_id),pc=oc.type,qc=ma({},jc);qc.forward_message_ids=mc;if((pc=='root'&&oc.value==qc.message_id)||(pc=='user')||(nc==u.PENDING_THREAD_ID)){qc.client_thread_id=qc.thread_id;qc.thread_id=null;this._sendNewMessageToServer(qc,kc);}else xa(this,qc.thread_id,function(rc){oc=this.tokenizeThreadID(qc.thread_id);if(oc.type=='user'){qc.other_user_fbid=oc.values;}else qc.thread_fbid=rc;qc.thread_id=null;this._sendNewMessageToServer(qc);}.bind(this));}.bind(this));if(jc.thread_id!=u.PENDING_THREAD_ID){var lc={actions:[ma({},jc)],from_client:true,payload_source:aa.CLIENT_SEND_MESSAGE};this.handleUpdate(lc);}},_sendNewMessageToServer:function(jc,kc){g.inform(k.ATTEMPT_RECONNECT);kc=kc||qa;this._sentMessagesTimestamp[jc.message_id]=Date.now();ic(this,'/ajax/mercury/send_messages.php',{message_batch:[jc],client:kc});},requestMessageConfirmation:function(jc,kc){if(s.MercuryFBIDGK){this.requestMessageConfirmationFBID(jc,kc);}else this.requestMessageConfirmationThreadID(jc,kc);},requestMessageConfirmationThreadID:function(jc,kc){kc=kc||qa;var lc={},mc={};for(var nc in jc){var oc=ya(this,nc);if(oc){lc[oc]=jc[nc];}else{var pc=jc[nc];for(var qc=0;qc<pc.length;qc++)mc[pc[qc]]=nc;}}var rc=Object.keys(lc),sc=Object.keys(mc);if(rc.length||sc.length)ic(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:lc,local_messages:mc,client:kc});},requestMessageConfirmationFBID:function(jc,kc){kc=kc||qa;var lc={},mc={};for(var nc in jc){var oc=za(this,nc);if(oc){lc[oc]=jc[nc];}else{var pc=jc[nc];for(var qc=0;qc<pc.length;qc++)mc[pc[qc]]=nc;}}var rc=Object.keys(lc),sc=Object.keys(mc);if(rc.length||sc.length)ic(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:lc,local_messages:mc,client:kc});},handleMessageConfirmError:function(jc){if(s.MercuryFBIDGK){this.handleMessageConfirmErrorFBID(jc);}else this.handleMessageConfirmErrorThreadID(jc);},handleMessageConfirmErrorThreadID:function(jc){var kc=jc.getRequest().getData().thread_message_map,lc=jc.getRequest().getData().local_messages;if(!kc&&!lc)return;var mc=[];for(var nc in kc){var oc=kc[nc];oc.forEach(function(rc){mc.push({action_type:p.SEND_MESSAGE,client_message_id:rc,message_id:rc,client_thread_id:null,thread_id:nc,status:o.UNABLE_TO_CONFIRM});});}for(var pc in lc){var qc=lc[pc];mc.push({action_type:p.SEND_MESSAGE,client_message_id:pc,message_id:pc,client_thread_id:qc,thread_id:null,status:o.UNABLE_TO_CONFIRM});}if(mc.length)this.handleUpdate({actions:mc,payload_source:aa.CLIENT_HANDLE_ERROR});},handleMessageConfirmErrorFBID:function(jc){var kc=jc.getRequest().getData().thread_message_map,lc=jc.getRequest().getData().local_messages;if(!kc&&!lc)return;var mc=[];for(var nc in kc){var oc=kc[nc];oc.forEach(function(rc){mc.push({action_type:p.SEND_MESSAGE,client_message_id:rc,message_id:rc,client_thread_id:null,thread_fbid:nc,status:o.UNABLE_TO_CONFIRM});});}for(var pc in lc){var qc=lc[pc];mc.push({action_type:p.SEND_MESSAGE,client_message_id:pc,message_id:pc,client_thread_id:qc,thread_fbid:null,status:o.UNABLE_TO_CONFIRM});}if(mc.length)this.handleUpdate({actions:mc,payload_source:aa.CLIENT_HANDLE_ERROR});},markSeen:function(){var jc=this._lastActionTimestamp;ic(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:jc});},handleRoger:function(jc){var kc=jc.tid?this._serverToClientIDs.getResource(jc.tid):('user:'+jc.reader);if(kc){var lc={};lc[kc]={};lc[kc]['fbid:'+jc.reader]=jc.time;this.inform('update-roger',lc);}},handleUpdateWaitForThread:function(jc,kc,lc){if(s.MercuryFBIDGK){this.handleUpdateWaitForThreadFBID(jc,kc,lc);}else this.handleUpdateWaitForThreadThreadID(jc,kc,lc);},handleUpdateWaitForThreadThreadID:function(jc,kc,lc){lc=lc||qa;var mc=this._serverToClientIDs.getResource(kc);if(mc){this.handleUpdate(jc);return;}this._serverToClientIDs.executeOrEnqueue(kc,function(){this._pendingUpdates.push(jc);}.bind(this));if(!this._fetchingThreads[kc]){this._fetchingThreads[kc]=true;ic(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[kc]},client:lc});}},handleUpdateWaitForThreadFBID:function(jc,kc,lc){lc=lc||qa;var mc=this._FBIDToClientIDs.getResource(kc);if(mc){this.handleUpdate(jc);return;}this._FBIDToClientIDs.executeOrEnqueue(kc,function(){this._pendingUpdates.push(jc);}.bind(this));if(!this._fetchingThreads[kc]){this._fetchingThreads[kc]=true;var nc={threads:{thread_fbids:[kc]},client:lc};if(this.isUser(kc))nc={threads:{user_ids:[kc]},client:lc};ic(this,'/ajax/mercury/thread_info.php',nc);}},handleUpdate:function(jc){var kc=[];if(jc&&jc.threads)for(var lc=0;lc<jc.threads.length;lc++){if(!jc.threads[lc].snippet_attachments)continue;for(var mc=0;mc<jc.threads[lc].snippet_attachments.length;mc++)if(jc.threads[lc].snippet_attachments[mc].share_xhp){kc.push({i:lc,j:mc,xhp:jc.threads[lc].snippet_attachments[mc].share_xhp});jc.threads[lc].snippet_attachments[mc].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}var nc={actions:[],threads:[]};if(jc){if(jc.actions)for(var oc=0;oc<jc.actions.length;oc++){var pc=ma({},jc.actions[oc]);x.obfuscateAction(pc);nc.actions.push(pc);}if(jc.threads)for(oc=0;oc<jc.threads.length;oc++){var qc=ma({},jc.threads[oc]);x.obfuscateThread(qc);nc.threads.push(qc);}}var rc=ma({},jc,nc);pa.debug('handle_update',{payload:rc,from_client:jc.from_client});for(var sc=0;sc<kc.length;sc++)jc.threads[kc[sc].i].snippet_attachments[kc[sc].j].share_xhp=kc[sc].xhp;for(sc in jc){la.getForFBID(this._fbid).synchronizeInforms(function(){if(!jc.from_client){if(s.MercuryFBIDGK){mb(this,jc);}else lb(this,jc);this.inform('payload-preprocessed',jc);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',jc);this.inform('update-threads',jc);this.inform('update-unread',jc);this.inform('update-threadlist',jc);this.inform('update-messages',jc);this.inform('update-unseen',jc);this.inform('update-typing-state',jc);this.inform('update-roger',jc.roger);this.inform('model-update-completed',null);nb(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(jc,kc,lc,mc){pa.debug('handle_send_message_error_common',{reliability_error_status:lc,request_error_status:kc});var nc=jc.getData(),oc=nc.message_batch,pc=oc.map(function(rc){var sc={action_type:p.SEND_MESSAGE,thread_id:rc.thread_id,client_message_id:rc.message_id,message_id:rc.message_id,client_thread_id:rc.client_thread_id,status:kc,error_data:mc};if(s.MercuryFBIDGK){sc.thread_fbid=rc.thread_fbid;}else sc.thread_id=rc.thread_id;return sc;});if(s.MercuryFBIDGK){pc.forEach(function(rc){hb(this,rc,lc);}.bind(this));}else pc.forEach(function(rc){gb(this,rc,lc);}.bind(this));var qc={actions:pc,payload_source:aa.CLIENT_HANDLE_ERROR};this.handleUpdate(qc);},handleSendMessageError:function(jc){var kc=jc.getPayload(),lc=null,mc=null;if(kc&&kc.error_payload){lc=o.UNCONFIRMED;mc='send_error';}else{lc=o.ERROR;mc='request_error'+ib(jc);}var nc=jc.error;if(nc===1404102)i.verboseErrorHandler(jc);var oc=/<.*>/.test(jc.getErrorDescription())?jc.getErrorSummary():jc.getErrorDescription();this._handleSendMessageErrorCommon(jc.getRequest(),lc,mc,{type:t.SERVER,code:jc.getError(),description:oc,is_transient:jc.isTransient()});},handleSendMessageTransportError:function(jc){this._handleSendMessageErrorCommon(jc.getRequest(),o.ERROR,'transport_error'+ib(jc),{type:t.TRANSPORT,code:jc.getError(),is_transient:true});},handleSendMessageTimeout:function(jc){this._handleSendMessageErrorCommon(jc,o.ERROR,'transport_timeout',{type:t.TIMEOUT,is_transient:true});},getLastActionTimestamp:function(){return this._lastActionTimestamp;}});ma(vb,da);function wb(jc){return {action_type:p.LOG_MESSAGE,thread_id:jc,message_id:jc,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:ea.UNKNOWN,log_message_type:y.SERVER_ERROR,log_message_data:{}};}function xb(jc){var kc=jc.getData(),lc=kc.request_user_id?kc.request_user_id:l.getID();return vb.getForFBID(lc);}function yb(jc,kc){xb(kc).handleUpdate(jc);}function zb(jc,kc){var lc=jc.client||kc.client;return {client:lc,message_batch:jc.message_batch.concat(kc.message_batch)};}function ac(jc,kc){var lc={};ma(lc,jc.ids);ma(lc,kc.ids);var mc=jc.client||kc.client;return {ids:lc,client:mc};}function bc(jc,kc){return kc;}function cc(jc){var kc=xb(jc.getRequest());kc.handleThreadInfoError(jc);}function dc(jc){var kc=xb(jc.getRequest());kc.handleSendMessageError(jc);}function ec(jc){var kc=xb(jc.getRequest());kc.handleSendMessageTransportError(jc);}function fc(jc){var kc=xb(jc);kc.handleSendMessageTimeout(jc);}function gc(jc){var kc=xb(jc.getRequest());kc.handleMessageConfirmError(jc);}function hc(jc){ka.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:jc._fbid,mode:ka.IDEMPOTENT,handler:yb},'/ajax/mercury/thread_info.php':{request_user_id:jc._fbid,mode:ka.BATCH_DEFERRED_MULTI,batch_function:ob,handler:yb,error_handler:cc},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb},'/ajax/mercury/change_read_status.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:ac,handler:yb},'/ajax/mercury/send_messages.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:zb,batch_size_limit:ha.SEND_BATCH_LIMIT,handler:yb,error_handler:dc,transport_error_handler:ec,timeout:ca.sendMessageTimeout,timeout_handler:fc,connection_retries:ha.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:bc,handler:yb},'/ajax/mercury/confirm_messages.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb,error_handler:gc},'/ajax/mercury/threadlist_info.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:qb,handler:yb},'/ajax/mercury/mark_spam.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb},'/ajax/mercury/mark_spam_messages.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb},'/ajax/mercury/unmark_spam.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb},'/ajax/mercury/unread_threads.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE_UNIQUE,batch_function:pb,handler:yb},'/ajax/chat/settings.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:sb,handler:yb},'/ajax/mercury/delete_thread.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:ub,handler:yb},'/ajax/mercury/delete_messages.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb},'/ajax/mercury/move_thread.php':{request_user_id:jc._fbid,mode:ka.BATCH_SUCCESSIVE,batch_function:tb,handler:yb},'/ajax/mercury/change_mute_thread.php':{request_user_id:jc._fbid,mode:ka.IMMEDIATE,handler:yb}});}function ic(jc,kc,lc,mc){ka.trySend(kc,lc,mc,jc._fbid);}e.exports=vb;},null);
__d("MercuryParticipants",["CurrentUser","ImageSourceRequest","ImageSourceType","MercuryAssert","MercuryIDs","MercuryParticipantsConstants","MercuryParticipantTypes","PhotoResizeModeConst","ShortProfiles","copyProperties","getObjectValues","tx","MercuryServerRequests"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s=b('MercuryServerRequests').get(),t='fbid:'+g.getID(),u={},v={},w=function(ba){ba=z(ba);if(u[ba.id]){p(u[ba.id],ba);}else u[ba.id]=p({},ba);if(ba.vanity)v[ba.vanity]=ba.id;};function x(ba){j.isEmailParticipantID(ba);var ca=k.tokenize(ba),da=ca.value;return {gender:l.UNKNOWN_GENDER,href:null,id:ba,image_src:l.EMAIL_IMAGE,big_image_src:l.EMAIL_IMAGE,name:da,short_name:da,employee:false,call_promo:false};}function y(ba,ca,da){j.allParticipantIDs(ba);var ea={},fa={};ba.forEach(function(ha){if(u[ha]&&!da){ea[ha]=p({},u[ha]);}else{var ia=k.tokenize(ha);if(ia.type=='fbid'){var ja=ia.value;fa[ha]=ja;}else if(ia.type=='email')ea[ha]=x(ha);}});var ga=q(fa);if(ga.length){o.getMulti(ga,function(ha){for(var ia in fa){var ja=fa[ia],ka=ha[ja];ea[ia]={gender:ka.gender,href:ka.uri,id:ia,image_src:ka.thumbSrc,name:ka.name,short_name:ka.firstName,employee:ka.employee,call_promo:ka.showVideoPromo,type:ka.type,vanity:ka.vanity,is_friend:ka.is_friend,orion_eligible:ka.orionEligible,social_snippets:ka.social_snippets};w(ea[ia]);}ca(ea);});}else ca(ea);}function z(ba){var ca=ba.type===m.USER||ba.type===m.FRIEND;if(!ca)return ba;if(!ba.name&&!ba.href&&!ba.vanity){var da="Facebook User";ba.name=da;ba.short_name=da;}return ba;}var aa={user:t,isAuthor:function(ba){return ba===t;},getIDFromVanityOrFBID:function(ba){if(!ba)return;if(v[ba])return v[ba];if(ba.match('^\\d+$'))return aa.getIDForUser(ba);},getNow:function(ba){return u[ba];},get:function(ba,ca){j.isParticipantID(ba);aa.getMulti([ba],function(da){ca(da[ba]);});},getMulti:function(ba,ca,da){return y(ba,ca,false);},getMap:function(ba,ca){var da=[];for(var ea in ba)if(Array.isArray(ba[ea])){da=da.concat(ba[ea]);}else if(ba[ea])da.push(ba[ea]);this.getMulti(da,function(fa){var ga={};for(var ha in ba)if(Array.isArray(ba[ha])){ga[ha]=ba[ha].map(function(ia){return fa[ia];});}else ga[ha]=fa[ba[ha]];ca(ga);});},getBigImageMulti:function(ba,ca){j.allParticipantIDs(ba);var da=l.BIG_IMAGE_SIZE;aa.getMulti(ba,function(ea){var fa={},ga=0,ha=function(la,ma){ga++;fa[la]=ma;if(ga===ba.length)ca(fa);},ia=function(la,ma){u[la].big_image_src=ma.uri;ha(la,ma.uri);};for(var ja in ea){var ka=ea[ja];if(!ka.big_image_src){new h().setFBID(aa.getUserID(ja)).setType(i.PROFILE_PICTURE).setDimensions(da,da).setResizeMode(n.COVER).setCallback(ia.bind(null,ja)).send();}else ha(ka.id,ka.big_image_src);}});},getOrderedBigImageMulti:function(ba,ca){aa.getBigImageMulti(ba,function(da){var ea=ba.map(function(fa){return da[fa];});ca(ea);});},getMultiForceDownload:function(ba,ca){return y(ba,ca,true);},getUserID:function(ba){return k.getUserIDFromParticipantID(ba);},getIDForUser:function(ba){return 'fbid:'+ba;},addParticipants:function(ba){ba.forEach(w);}};s.subscribe('update-participants',function(ba,ca){aa.addParticipants(ca.participants||[]);});e.exports=aa;},null);
__d("ReportState",["ErrorUtils","invariant"],function(a,b,c,d,e,f,g,h){var i={};function j(l,m){h(!i[l]);i[l]=m;}function k(){var l={};Object.keys(i).forEach(function(m){try{l[m]=i[m]();}catch(n){g.reportError('ReportState: callback threw an error.');}});return l;}e.exports={registerCallback:j,getState:k};},null);
__d("MercuryThreads",["MercuryFolders","KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryConfig","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryPayloadSource","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryParticipants","ReportState","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){function aa(na,oa,pa){var qa=y(oa.participants,true),ra=t.getIDForUser(na._fbid);pa.forEach(function(sa){if(qa[sa]!==true){oa.participants.push(sa);if(sa===ra)oa.is_subscribed=true;}});}function ba(na,oa,pa){pa.forEach(function(qa){z(oa.participants,qa);if(qa===t.getIDForUser(na._fbid))oa.is_subscribed=false;});}function ca(na,oa){if(na.participants[0]!=oa){z(na.participants,oa);na.participants.unshift(oa);}}function da(na,oa){var pa=oa.body,qa=oa.subject,ra='';if(qa){qa=qa.toLowerCase();if(pa.slice(0,qa.length).toLowerCase()==qa){ra=pa;}else if(pa){ra=qa+' \u00B7 '+pa;}else ra=qa;}else ra=pa;na.snippet=ra;na.snippet_has_attachment=oa.has_attachment;if(oa.raw_attachments&&oa.raw_attachments.length>0){var sa=k.convertRaw(oa.raw_attachments);na.snippet_attachments=sa;}else na.snippet_attachments=oa.attachments;na.is_forwarded_snippet=!!oa.forward_count;na.snippet_sender=oa.author;}function ea(na,oa,pa){if(!oa)return false;if(!l.ReadStatusGK&&!oa.timestamp)return true;var qa=!oa.unread_count;if(pa==qa)return false;oa.unread_count=pa?0:1;na._threadInformer.updatedThread(oa.thread_id);return true;}function fa(na,oa){var pa=na._threads.getAllResources();for(var qa in pa){var ra=pa[qa];if(ra.folder==oa){ra.unread_count=0;na._threads.setResource(qa,ra);na._threadInformer.updatedThread(qa);}}}function ga(na,oa,pa){if(!oa||oa.chat_clear_time===pa)return false;oa.chat_clear_time=pa;na._threadInformer.reorderedMessages(oa.thread_id);return true;}function ha(na,oa,pa,qa){if(pa.timestamp)na._threadInformer.changedThreadReadState(oa.thread_id,qa,pa.timestamp);ea(na,oa,qa);}function ia(na,oa,pa,qa){var ra=pa.action_type;if(ra==i.USER_GENERATED_MESSAGE||ra==i.LOG_MESSAGE){pa.is_unread&&oa.unread_count++;oa.message_count++;oa.is_archived=false;}switch(ra){case i.USER_GENERATED_MESSAGE:if(oa.last_read_timestamp>=pa.timestamp)ha(na,oa,pa,true);ca(oa,pa.author);break;case i.SEND_MESSAGE:var sa=pa.log_message_type;if(sa==o.THREAD_IMAGE)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;oa.snippet_attachments=pa.attachments;break;case i.LOG_MESSAGE:var sa=pa.log_message_type;if(sa==o.SUBSCRIBE){aa(na,oa,pa.log_message_data.added_participants);}else if(sa==o.UNSUBSCRIBE){ba(na,oa,pa.log_message_data.removed_participants);}else if(sa==o.THREAD_IMAGE){if(!qa)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;}else if(sa==o.THREAD_NAME)oa.name=pa.log_message_data.name;break;case i.CHANGE_READ_STATUS:if(pa.timestamp)oa.last_read_timestamp=pa.timestamp;ha(na,oa,pa,pa.mark_as_read);break;case i.CLEAR_CHAT:ga(na,oa,pa.clear_time);break;case i.CHANGE_ARCHIVED_STATUS:oa.is_archived=pa.archived;break;case i.CHANGE_FOLDER:oa.folder=pa.new_folder;break;case i.DELETE_MESSAGES:if(qa){oa.snippet='...';oa.snippet_has_attachment=false;oa.snippet_attachments=null;oa.snippet_sender=null;oa.is_forwarded_snippet=false;na._threadInformer.updatedThread(pa.thread_id);}else if(pa.message_ids)oa.message_count=oa.message_count-pa.message_ids.length;break;case i.CHANGE_MUTE_SETTINGS:if(pa.mute_settings!==undefined){var ta=na._fbid+'@facebook.com';if(oa.mute_settings){if(pa.mute_settings){oa.mute_settings[ta]=pa.mute_settings;}else delete oa.mute_settings[ta];na._threadInformer.updatedThread(oa.thread_id);}}break;}}function ja(na,oa){var pa=na._serverRequests.tokenizeThreadID(oa.thread_id),qa=la(na,oa.specific_to_list),ra={thread_id:oa.thread_id,last_action_id:null,participants:oa.specific_to_list,name:null,snippet:oa.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:oa.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:oa.timestamp_absolute,timestamp_relative:oa.timestamp_relative,timestamp:oa.timestamp,canonical_fbid:pa.type==='user'?pa.value:null,is_canonical_user:pa.type==='user',is_canonical:qa,is_subscribed:true,root_message_threading_id:oa.message_id,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};return ra;}function ka(na){this._fbid=na;this._serverRequests=v.getForFBID(this._fbid);this._threadInformer=w.getForFBID(this._fbid);this._threads=new h();ma(this);}x(ka.prototype,{getThreadMetaNow:function(na){j.isThreadID(na);return this._threads.getResource(na);},getThreadMeta:function(na,oa,pa){var qa=function(ra){oa(ra[na]);};return this.getMultiThreadMeta([na],qa,pa);},getMultiThreadMeta:function(na,oa,pa){j.allThreadID(na);var qa=this._threads.executeOrEnqueue(na,oa),ra=this._threads.getUnavailableResources(qa);if(ra.length){var sa=[];for(var ta=0;ta<ra.length;ta++){var ua=ra[ta],va=this._serverRequests.tokenizeThreadID(ua);if(va.type=='user'){var wa=this.getCanonicalThreadToUser(va.value,null,pa,true);if(this.isEmptyLocalThread(wa.thread_id))sa.push(wa.thread_id);}else sa.push(ua);}if(sa.length)this._serverRequests.fetchThreadData(sa,pa);}return qa;},unsubscribe:function(na){this._threads.unsubscribe(na);},changeThreadReadStatus:function(na,oa){j.isThreadID(na);var pa=this._threads.getResource(na);if(ea(this,pa,oa))this._serverRequests.changeThreadReadStatus(na,oa,g.getFromMeta(pa));},changeThreadArchivedStatus:function(na,oa){j.isThreadID(na);var pa=this._threads.getResource(na);if(pa.is_archived!=oa){pa.is_archived=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadArchivedStatus(na,oa);}},markThreadSpam:function(na){this._serverRequests.markThreadSpam(na);},unmarkThreadSpam:function(na){this._serverRequests.unmarkThreadSpam(na);},updateThreadMuteSetting:function(na,oa){this._serverRequests.changeMutingOnThread(na,oa);},changeFolder:function(na,oa){j.isThreadID(na);var pa=this._threads.getResource(na);if(pa&&pa.folder!=oa){pa.folder=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadFolder(na,oa);}},deleteThread:function(na){j.isThreadID(na);this._serverRequests.deleteThread(na);},updateThreads:function(na){if(!na||!na.length)return;var oa={};na.forEach(function(pa){oa[pa.thread_id]=pa;});this._threads.addResourcesAndExecute(oa);},updateMetadataByActions:function(na,oa){if(!na||!na.length)return;var pa={},qa={},ra={};for(var sa=0;sa<na.length;sa++){var ta=na[sa];if(ta.is_forward)continue;var ua=ta.action_type,va=ta.thread_id;j.isThreadID(va);var wa=this.getThreadMetaNow(va);if(ua==i.LOG_MESSAGE&&ta.log_message_type==o.SERVER_ERROR)continue;var xa=!!(ta.sync_id||ta.action_id);if(!wa&&!xa&&ua==i.USER_GENERATED_MESSAGE){wa=ja(this,ta);this._threads.setResource(va,wa);}if(wa){if(ua==i.DELETE_THREAD){wa.message_count=0;this._threadInformer.deletedThread(va);continue;}if(ua==i.LOG_MESSAGE||ua==i.USER_GENERATED_MESSAGE)xa=!oa;if(wa.server_timestamp&&ta.timestamp<=wa.server_timestamp&&xa)continue;if(!ra[va])ra[va]=x({},wa);ia(this,ra[va],ta,oa);if(ua==i.USER_GENERATED_MESSAGE)pa[va]=ta;if(ua==i.USER_GENERATED_MESSAGE||ua==i.LOG_MESSAGE||ua==i.SEND_MESSAGE)if(ta&&ta.timestamp&&(!qa[va]||ta.timestamp>qa[va].timestamp))qa[va]=ta;}}for(var ya in ra){var za=ra[ya],ab=pa[ya];if(ab)da(za,ab);var bb=qa[ya],cb=za.timestamp;if(bb){if(bb.timestamp>cb)za=x(za,{timestamp_absolute:bb.timestamp_absolute,timestamp_relative:bb.timestamp_relative,timestamp:bb.timestamp});var db=za.server_timestamp;if(!oa&&bb.timestamp>db)za.server_timestamp=bb.timestamp;}this._threads.setResource(ya,za);}},getCanonicalThreadToUser:function(na,oa,pa,qa){return this.getCanonicalThreadToParticipant('fbid:'+na,oa,pa,qa);},getCanonicalThreadToParticipant:function(na,oa,pa,qa){var ra=this.getThreadIDForParticipant(na),sa=this._threads.getResource(ra);if(typeof sa=='undefined'){sa=this.createNewLocalThread(ra,[t.getIDForUser(this._fbid),na],oa);!qa&&this._serverRequests.fetchThreadData([ra],pa);}return sa;},getThreadIdForUser:function(na){return 'user:'+na;},getThreadIDForParticipant:function(na){var oa=n.tokenize(na);return this.getThreadIdForUser(oa.value);},createNewLocalThread:function(na,oa,pa){var qa=this._threads.getResource(na);if(!qa){var ra=this._serverRequests.tokenizeThreadID(na);qa={thread_id:na,last_action_id:null,participants:oa,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:pa?pa:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ra.type==='user'?ra.value:null,is_canonical_user:ra.type=='user',is_canonical:la(this,oa),is_subscribed:true,root_message_threading_id:null,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};this._threads.setResource(na,qa);}return qa;},addParticipantsToThreadLocally:function(na,oa){var pa=this._threads.getResource(na);if(pa){aa(this,pa,oa);this._threadInformer.updatedThread(pa.thread_id);}},getCanonicalUserInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='user'?oa.value:null;},getCanonicalGroupInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='group'?oa.value:null;},isEmptyLocalThread:function(na){var oa=this._threads.getResource(na);if(!oa)return false;var pa=this._serverRequests.tokenizeThreadID(na);return pa.type=='root'&&!oa.timestamp;},isNewEmptyLocalThread:function(na){if(!this.isEmptyLocalThread(na))return false;var oa=this._threads.getResource(na);return oa.participants&&oa.participants.length===0;},canReply:function(na){var oa=this._threads.getResource(na),pa=l.ReadOnlyEmailThreads&&oa.has_email_participant;return oa&&oa.is_subscribed&&oa.mode!=r.OBJECT_ORIGINATED&&!pa&&!oa.read_only&&(oa.recipients_loadable||oa.recipients_loadable===undefined);}});x(ka,q);function la(na,oa){var pa=oa.filter(function(qa){return qa!=t.getIDForUser(na._fbid);});return pa.length<=1;}function ma(na){na._serverRequests.subscribe('update-threads',function(oa,pa){var qa=(pa.actions||[]).filter(function(ua){return ua.thread_id;});if(l.ReadStatusGK)if(pa.payload_source==p.SERVER_FETCH_THREAD_INFO)(pa.threads||[]).forEach(function(ua){var va=na._threads.getResource(ua.thread_id);if(ua.unread_count&&va)na._serverRequests.changeThreadReadStatus(ua.thread_id,true,va.folder);});na.updateThreads(pa.threads);na.updateMetadataByActions(qa,pa.from_client);(pa.threads||[]).forEach(function(ua){na._threadInformer.updatedThread(ua.thread_id);});var ra=pa.global_actions||[];for(var sa=0;sa<ra.length;sa++){var ta=ra[sa];if(ta.action_type==m.MARK_ALL_READ)fa(na,ta.folder);}});}u.registerCallback('mercury-threads',function(){var na={};na.threads={};var oa=ka._getInstances();for(var pa in oa)na.threads[pa]=oa[pa]._threads.dumpResources();return na;});e.exports=ka;},null);
__d("WebMessengerPermalinkConstants",["URI"],function(a,b,c,d,e,f,g){var h={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(i,j){return (j||h.BASE_PATH)+h.TID_POSTFIX_PARTIAL_PATH+g.encodeComponent(g.encodeComponent(i));},getThreadIDFromURI:function(i){var j=i.getPath().match(h.BASE_PATH+'(/[^/]*)*'+h.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(j){var k=g.decodeComponent(g.decodeComponent(j[2]));return k;}},getURIPathForIDOrVanity:function(i,j){if(i.match('^'+h.overriddenVanities+'$'))i='.'+i;return (j||h.BASE_PATH)+'/'+i;},getUserIDOrVanity:function(i){var j=i.match(h.BASE_PATH+'.*/([^/]+)/?$'),k=j&&j[1],l=h.overriddenVanities;if(!k||k.match('^'+l+'$')){return false;}else if(k.match('^\\.'+l+'$')){return k.substr(1);}else return k;}};e.exports=h;},null);
__d("ChatTypeaheadConstants",[],function(a,b,c,d,e,f){var g={USER_TYPE:'user',THREAD_TYPE:'thread',FRIEND_TYPE:'friend',NON_FRIEND_TYPE:'non_friend',FB4C_TYPE:'fb4c',HEADER_TYPE:'header'};e.exports=g;},null);
__d("ChatOpenTab",["Event","requireWeak","ContextualThing","DOM","csx","cx","Parent"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=null;h(['ChatApp'],function(x){return n=x;});var o=null;h(['ChatTabModel'],function(x){return o=x;});var p=716,q='messaging_tracking';function r(){d(['Toggler'],function(x){var y=x.getInstance(j.scry(document,"div._1z4y")[0]);if(y&&y.getActive())y.hide();});}function s(x){d(['LogHistory','MercuryThreads','WebMessengerPermalinkConstants','goURI'],function(y,z,aa,ba){z.get().getThreadMeta(x,function(ca){if(n&&n.isInitialized()){n.tabController.openTab(x,n.tabsViewport);}else ba(aa.getURIPathForThreadID(x));if(!w.canOpenTab())y.getInstance('mercury').error('Unable to open chat tab',ca);});});if(document.documentElement.clientHeight<=p)r();}function t(x,y,z,aa){g.listen(x,'click',function(ba){if(w.canOpenTab()){aa(y,z);return ba.kill();}});}function u(x,y,z,aa){var ba={referrer:x||'',message_thread_id:y,message_view:'chat',timestamp_send:Date.now()};if(z!==undefined)ba.message_target_ids=[z];d(['ChatImpressionLogger'],function(ca){ca.logImpression(x,z,aa);});d(['Banzai'],function(ca){ca.post(q,ba,{delay:0,retry:true});});}function v(x){var y=i.getContext(x);return (y&&m.byClass(y,"_3qw")!==null);}var w={canOpenTab:function(){return n&&!n.isHidden();},openEmptyTab:function(x,y,z){if(w.canOpenTab()&&o){var aa=o.getEmptyTab();s(aa);u(y,aa,null,z);r();}},listenOpenEmptyTab:function(x,y){t(x,null,y,w.openEmptyTab);},openThread:function(x,y,z){d(['MercuryIDs','MercuryServerRequests'],function(aa,ba){if(aa.isValid(x)){s(x);}else ba.get().getClientThreadID(x,s);u(y,x,null,z);r();});},listenOpenThread:function(x,y,z){t(x,y,z,w.openThread);},openUserTab:function(x,y,z){d(['MercuryThreads'],function(aa){var ba=aa.get().getCanonicalThreadToUser(x);s(ba.thread_id);u(y,ba.thread_id,x,z);});return true;},listenOpenUserTab:function(x,y,z){if(!v(x))t(x,y,z,w.openUserTab);},openTabByType:function(x,y,z){d(['ChatTypeaheadConstants','MercuryParticipantTypes'],function(aa,ba){if(y===aa.THREAD_TYPE){if(x){w.openThread(x,z);}else w.openEmptyTab(null,z);}else if(!y||y===ba.FRIEND||y===aa.FRIEND_TYPE||y===aa.USER_TYPE)w.openUserTab(x,z);});}};e.exports=w;},null);
__d("SplitImage.react",["React","Image.react","cx","joinClasses"],function(a,b,c,d,e,f,g,h,i,j){var k=g.createClass({displayName:'SplitImage',render:function(){var l=this.props.size;return (g.createElement(g.DOM.div,Object.assign({},this.props,{className:j(this.props.className,"_55lt"),style:Object.assign({},(this.props.style||{}),{width:l,height:l})}),this.renderImages()));},renderImages:function(){if(!this.props.srcs)return null;var l=this.props.srcs,m=Array.isArray(l);if(!m||l.length==1)return this.renderOne(m?l[0]:l);return l.length==2?this.renderTwo(l):this.renderThree(l);},renderOne:function(l){return (g.createElement(h,{src:l,width:this.props.size,height:this.props.size,alt:""}));},renderTwo:function(l){var m=this.props.size,n=Math.floor(m/2),o=-Math.floor(n/2),p=(("_55lu")+(this.props.border?' '+"_57xo":''));return (g.createElement(g.DOM.div,null,g.createElement(g.DOM.div,{className:"_55lu",style:{width:n}},g.createElement(h,{src:l[0],width:m,height:m,style:{marginLeft:o}})),g.createElement(g.DOM.div,{className:p,style:{width:n}},g.createElement(h,{src:l[1],width:m,height:m,style:{marginLeft:o}}))));},renderThree:function(l){var m=this.props.size,n=Math.floor(m/3*2),o=-Math.floor((m-n)/2),p=Math.floor(m/2),q=m-n,r=-Math.floor((p-q)/2),s=(("_55lu")+(this.props.border?' '+"_57pl":'')),t=(("_55lu")+(this.props.border?' '+"_57pm":''));return (g.createElement(g.DOM.div,null,g.createElement(g.DOM.div,{className:s,style:{width:n}},g.createElement(h,{src:l[0],width:m,height:m,style:{marginLeft:o}})),g.createElement(g.DOM.div,{className:t,style:{width:q,height:p}},g.createElement(h,{src:l[1],width:p,height:p,style:{marginLeft:r}})),g.createElement(g.DOM.div,{className:"_55lu",style:{width:q,height:p}},g.createElement(h,{src:l[2],width:p,height:p,style:{marginLeft:r}}))));}});e.exports=k;},null);
__d("loadImage",[],function(a,b,c,d,e,f){"use strict";function g(h,i){var j=new Image();j.onload=function(){i(j.width,j.height,j);};j.src=h;}e.exports=g;},null);
__d("PhotoResizeMath",[],function(a,b,c,d,e,f){var g={getScaledPhotoDimensions:function(h,i,j,k,l){var m=h/i,n=j/k;if(j&&k&&l==='stretch')return {width:j,height:k};if((!j&&k)||((l==='contain')!==(m>=n)))return {width:k*m,height:k};if(j)return {width:j,height:j/m};return {width:h,height:i};}};e.exports=g;},null);
__d("PixelzFocus",[],function(a,b,c,d,e,f){"use strict";var g={search:function(h,i){var j=0,k=h.length-1;while(j<=k){var l=j+Math.floor((k-j)/2),m=h[l];if(m>i){k=l-1;}else if(m<i){j=l+1;}else return l;}return Math.min(j,k);},forceSpecificPoint:function(h,i,j){var k=1e-09,l=g.search(h,i-j-k)+1,m=g.search(h,i+j);return h.slice(l,m+1);},findBiggestSets:function(h,i){var j=[],k=-1;for(var l=0;l<h.length;++l){var m=h[l],n=l,o=g.search(h,m+i),p=o-n;if(p>k)j=[];if(p>=k){k=p;j.push({low:n,high:o});}}return j;},getBestSet:function(h,i,j){var k=-1,l=null;for(var m=0;m<i.length;++m){var n=i[m],o=h[n.low],p=h[n.high],q=o+(p-o)/2,r=Math.min(o-(q-j),(q+j)-p);if(r>k){k=r;l=n;}}return l;},getFocusFromSet:function(h,i){var j=h[i.low],k=h[i.high];return j+(k-j)/2;},clampFocus:function(h,i){var j=i/2,k=1-(i/2);if(h<j)return j;if(h>k)return k;return h;},convertFromCenterToCSS:function(h,i){if(Math.abs(1-i)<1e-05)return 0;return (h-i/2)/(1-i);},convertFromCSSToCenter:function(h,i){return h*(1-i)+i/2;},getVisible:function(h,i){if(h<i)return h/i;return i/h;},getHidden:function(h,i){return 1-g.getVisible(h,i);},focusHorizontally:function(h,i){return h<i;},convertVectorFromCenterToCSS:function(h,i,j){var k=g.focusHorizontally(i,j),l;if(k){l=h.x/100;}else l=h.x/100;var m=g.convertFromCenterToCSS(l,g.getVisible(i,j));if(k){return {x:m,y:0};}else return {x:0,y:m};},getCropRect:function(h,i,j){var k=g.focusHorizontally(i,j),l=g.getVisible(i,j);if(k){var m=(1-l)*h.x;return {left:m,top:0,width:l,height:1};}else{var n=(1-l)*h.y;return {left:0,top:n,width:1,height:l};}}};e.exports=g;},null);
__d("Pixelz.react",["arrayContains","copyProperties","cx","loadImage","joinClasses","React","PhotoResizeMath","PixelzFocus"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";var o=l.PropTypes,p=l.createClass({displayName:'Pixelz',propTypes:{width:o.number,height:o.number,resizeMode:o.oneOf(['contain','cover','stretch']),alt:o.string,letterbox:o.bool,borderRadius:o.number,insetBorderColor:o.string,animated:o.bool,upscale:o.bool,cropRect:function(q,r,s){var t=q[r],u='Invalid prop `'+r+'` supplied to `'+s+'`, expected a rectangle with values normalized '+'between 0 and 1.';if(t.left<0||t.top<0||t.width<0||t.height<0||t.left+t.width>1||t.top+t.height>1)return new Error(u);},focus:function(q,r,s){var t=q[r],u='Invalid prop `'+r+'` supplied to `'+s+'`, expected either a {x, y, type} vector where type '+'is `css` or `center` or an array of {x, y} vectors. All the vectors '+'have with values normalized between 0 and 1.';if(Array.isArray(t)){for(var v=0;v<t.length;++v)if(!(t[v].x>=0&&t[v].x<=1)||!(t[v].y>=0&&t[v].y<=1))return new Error(u);}else{if(!t.type)t.type='css';if(!(t.x>=0&&t.x<=1)||!(t.y>=0&&t.y<=1)||!g(['center','css'],t.type))return new Error(u);}}},getDefaultProps:function(){return {resizeMode:'cover',alt:'',letterbox:true,upscale:true,cropRect:{width:1,height:1,top:0,left:0},focus:{x:.5,y:.5,type:'css'}};},getInitialState:function(){return {srcDimensions:{}};},getSrcDimensions:function(){var q=this.props.src,r=this.state.srcDimensions[q];if(r)return r;j(q,function(s,t){var u={};u[q]={width:s,height:t};this.setState({srcDimensions:u});}.bind(this));return null;},getCropSrcDimensions:function(){var q=this.getSrcDimensions();return {width:q.width*this.props.cropRect.width,height:q.height*this.props.cropRect.height};},getUpscaleCropDimensions:function(){var q=this.getCropSrcDimensions();return m.getScaledPhotoDimensions(q.width,q.height,this.props.width,this.props.height,this.props.resizeMode);},getCropDimensions:function(){var q=this.getUpscaleCropDimensions(),r=this.getCropSrcDimensions();if(!this.props.upscale)return {width:Math.min(q.width,r.width),height:Math.min(q.height,r.height)};return q;},getCropAspectRatio:function(){var q=this.getCropDimensions();return q.width/q.height;},getContainerDimensions:function(){if(this.props.letterbox&&this.props.width&&this.props.height)return {width:this.props.width,height:this.props.height};return this.getCropDimensions();},getContainerAspectRatio:function(){var q=this.getContainerDimensions();return q.width/q.height;},getContainerPosition:function(){return {left:0,top:0};},getFocus:function(){var q=this.props.focus;if(!Array.isArray(q)&&q.type==='css')return {x:q.x,y:q.y};var r=this.getContainerAspectRatio(),s=this.getCropAspectRatio(),t=n.getVisible(r,s),u=n.focusHorizontally(r,s),v;if(!Array.isArray(q)){v=n.convertFromCenterToCSS(u?q.x:q.y,t);}else{var w=q.map(function(z){return u?z.x:z.y;});w.sort();var x=n.findBiggestSets(w,t),y=n.getBestSet(w,x,t);v=n.getFocusFromSet(w,y);}return {x:u?v:.5,y:u?.5:v};},getCropPosition:function(){var q=this.getCropDimensions(),r=this.getContainerDimensions(),s=this.getFocus();return {left:s.x*(r.width-q.width),top:s.y*(r.height-q.height)};},getScaleDimensions:function(){var q=this.getCropDimensions();return {width:q.width/this.props.cropRect.width,height:q.height/this.props.cropRect.height};},getScalePosition:function(){var q=this.getScaleDimensions();return {left:-q.width*this.props.cropRect.left,top:-q.height*this.props.cropRect.top};},getClipCropRectangle:function(){var q=this.getContainerDimensions(),r=this.getCropDimensions(),s=this.getContainerPosition(),t=this.getCropPosition(),u=Math.max(s.left,t.left),v=Math.max(s.top,t.top),w=Math.min(s.top+q.height,t.top+r.height),x=Math.min(s.left+q.width,t.left+r.width);return {left:u,top:v,width:x-u,height:w-v};},getClipCropPosition:function(){var q=this.getClipCropRectangle();return {left:q.left,top:q.top};},getClipCropDimensions:function(){var q=this.getClipCropRectangle();return {width:q.width,height:q.height};},getClipScalePosition:function(){var q=this.getScalePosition(),r=this.getClipCropPosition(),s=this.getCropPosition();return {left:q.left+(s.left-r.left),top:q.top+(s.top-r.top)};},getClipScaleDimensions:function(){return this.getScaleDimensions();},areDimensionsEqual:function(q,r){return q.width===r.width&&q.height===r.height;},shouldAddAllNodesAndStyles:function(){return this.props.animated;},hasCrop:function(){if(this.shouldAddAllNodesAndStyles())return true;var q=this.getContainerDimensions(),r=this.getClipCropDimensions(),s=this.getClipScaleDimensions();if(this.areDimensionsEqual(q,r)||this.areDimensionsEqual(r,s))return false;return true;},hasContainer:function(){if(this.shouldAddAllNodesAndStyles()||this.hasInsetBorder())return true;var q=this.getContainerDimensions(),r=this.getClipScaleDimensions();if(this.areDimensionsEqual(q,r))return false;return true;},hasInsetBorder:function(){return this.shouldAddAllNodesAndStyles()||this.props.insetBorderColor;},applyPositionStyle:function(q,r){if(this.shouldAddAllNodesAndStyles()||r.left)q.left=Math.round(r.left);if(this.shouldAddAllNodesAndStyles()||r.top)q.top=Math.round(r.top);},applyDimensionsStyle:function(q,r){q.width=Math.round(r.width);q.height=Math.round(r.height);},applyBorderRadiusStyle:function(q){if(this.shouldAddAllNodesAndStyles()||this.props.borderRadius)q.borderRadius=this.props.borderRadius||0;},getScaleStyle:function(){var q={},r=this.getClipCropDimensions(),s=this.getClipScaleDimensions();if(this.shouldAddAllNodesAndStyles()||!this.areDimensionsEqual(r,s)){this.applyPositionStyle(q,this.getClipScalePosition());}else this.applyPositionStyle(q,this.getClipCropPosition());this.applyDimensionsStyle(q,this.getClipScaleDimensions());this.applyBorderRadiusStyle(q);return q;},getCropStyle:function(){var q={};this.applyPositionStyle(q,this.getClipCropPosition());this.applyDimensionsStyle(q,this.getClipCropDimensions());this.applyBorderRadiusStyle(q);return q;},getInsetBorderStyle:function(){var q={borderColor:this.props.insetBorderColor||'transparent'};this.applyPositionStyle(q,this.getClipCropPosition());this.applyDimensionsStyle(q,this.getClipCropDimensions());this.applyBorderRadiusStyle(q);return q;},getContainerStyle:function(){var q={};this.applyDimensionsStyle(q,this.getContainerDimensions());this.applyBorderRadiusStyle(q);return q;},getScale:function(){var q=this.getScaleStyle(),r=q.width,s=q.height;q=h({},q);delete q.width;delete q.height;return (l.createElement(l.DOM.img,Object.assign({},this.props,{alt:this.props.alt,className:k(this.props.className,(("_56wb")+(this.shouldAddAllNodesAndStyles()?' '+"_56t5":''))),src:this.props.src,style:Object.assign({},(this.props.style||{}),q),width:r,height:s})));},getCrop:function(){var q=this.getScale();if(!this.hasCrop())return q;return (l.createElement(l.DOM.div,{className:(("_56ma")+(this.shouldAddAllNodesAndStyles()?' '+"_56t5":'')),style:this.getCropStyle()},q));},getInsetBorder:function(){if(!this.hasInsetBorder())return null;return (l.createElement(l.DOM.div,{className:(("_56lv")+(this.shouldAddAllNodesAndStyles()?' '+"_56t5":'')),style:this.getInsetBorderStyle()}));},getContainer:function(){var q=this.getCrop();if(!this.hasContainer())return q;var r=this.getInsetBorder();return (l.createElement(l.DOM.div,{className:(("_56jj")+(this.shouldAddAllNodesAndStyles()?' '+"_56t5":'')),style:this.getContainerStyle()},q,r));},render:function(){var q=this.getSrcDimensions();if(!q)return l.createElement(l.DOM.span,null);return this.getContainer();}});e.exports=p;},null);
__d("filterObject",[],function(a,b,c,d,e,f){'use strict';var g=Object.prototype.hasOwnProperty;function h(i,j,k){if(!i)return null;var l={};for(var m in i)if(g.call(i,m)&&j.call(k,i[m],m,i))l[m]=i[m];return l;}e.exports=h;},null);
__d("MercuryThreadMuter",["AsyncDialog","AsyncRequest","CurrentUser","DOM","MercuryThreads"],function(a,b,c,d,e,f,g,h,i,j){var k=b('MercuryThreads').get(),l={getUserIDEmail:function(){return i.getID()+'@facebook.com';},getThreadMuteSettingForUser:function(m){return m.mute_settings&&m.mute_settings[l.getUserIDEmail()];},isThreadMuted:function(m){return l.getThreadMuteSettingForUser(m)!==undefined;},showMuteChangeDialog:function(m){g.send(new h('/ajax/mercury/mute_thread_dialog.php'),function(n){n.subscribe('confirm',function(){this.hide();var o;j.scry(this.getRoot(),'input[type="radio"]').forEach(function(r){if(r.checked)o=r.value;});switch(o){case 'always':o=-1;break;case '1hour':o=3600;break;case '8am':var p=new Date(),q=new Date();q.setHours(8);q.setMinutes(0);q.setSeconds(0);if(q>p){o=q-p;}else o=q-p+(24*3600*1000);o/=1000;break;default:o=0;}k.updateThreadMuteSetting(m,o);}.bind(n));});}};e.exports=l;},null);
__d("MercuryThreadImage.react",["MercuryParticipants","MercuryParticipantsConstants","Pixelz.react","React","SplitImage.react"],function(a,b,c,d,e,f,g,h,i,j,k){'use strict';var l=j.createClass({displayName:'MercuryThreadImage',propTypes:{thread:j.PropTypes.object.isRequired,viewer:j.PropTypes.string.isRequired},getInitialState:function(){return {participantImages:[]};},componentDidMount:function(){this._getParticipantImages(this.props);},componentWillReceiveProps:function(m,n){this._getParticipantImages(m);},render:function(){if(this.props.thread.image_src)return (j.createElement(i,{height:h.BIG_IMAGE_SIZE,resizeMode:'cover',src:this.props.thread.image_src,width:h.BIG_IMAGE_SIZE}));if(this.state.participantImages.length>0)return (j.createElement(k,{srcs:this.state.participantImages,border:true,size:h.BIG_IMAGE_SIZE}));return null;},_getParticipantImages:function(m){var n=m.thread,o=m.viewer;if(n.image_src)return;var p=g.getIDForUser(o),q=n.participants.filter(function(s){return s!=p;}),r=[];if(!q.length){r=[p];}else if(q.length==1){r=q;}else r=q.slice(0,3);g.getOrderedBigImageMulti(r,function(s){this.isMounted()&&this.setState({participantImages:s});}.bind(this));}});e.exports=l;},null);
__d("MercuryErrorInfo",["MercuryActionStatus","MercuryErrorType","fbt"],function(a,b,c,d,e,f,g,h,i){var j={getMessage:function(k){var l='';if(j.isConnectionError(k)){l="This message didn't send.";if(j.isTransient(k))l=i._("{message} Check your internet connection and click to try again.",[i.param("message",l)]);}else{if(k&&k.description){l=k.description;}else l="This message failed to send.";if(j.isTransient(k))l=i._("{message} Click to send again.",[i.param("message",l)]);}return l;},isConnectionError:function(k){if(k&&k.type==h.TRANSPORT)return k.code===1001||k.code===1004||k.code===1006;return false;},isTransient:function(k){return k&&k.is_transient;},isPermanent:function(k){return k?!this.isTransient(k):false;},hasErrorStatus:function(k){return k.status===g.FAILED_UNKNOWN_REASON||k.status===g.UNABLE_TO_CONFIRM||k.status===g.ERROR;}};e.exports=j;},null);
__d("MercuryMessages",["AsyncRequest","BanzaiODS","CurrentUser","KeyedCallbackManager","MercuryActionStatus","MercuryActionTypeConstants","MercuryAssert","MercuryAttachmentType","MercuryGenericConstants","MercuryIDs","MercuryLogMessageType","MercuryMessageClientState","MercuryMessageSourceTags","MercuryPayloadSource","MercurySendLogger","MercurySingletonMixin","MercurySourceType","MercuryTimePassed","MercuryMessageIDs","MercuryParticipants","PresenceUtil","RangedCallbackManager","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","copyProperties","debounceAcrossTransitions","formatDate","invariant","isNode","randomInt","tx"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma){'use strict';function na(fb,gb){var hb=gb;if(fb._localIdsMap[gb])hb=fb._localIdsMap[gb];return fb._messages[hb];}var oa=new j();function pa(fb,gb){if(gb.status===undefined)gb.status=k.UNSENT;gb.timestamp_absolute="Today";gb.message_id=gb.message_id||fb.generateNewClientMessageID(gb.timestamp);var hb=z.getIDForUser(fb._fbid);gb.specific_to_list=gb.specific_to_list||[];if(gb.specific_to_list.length&&gb.specific_to_list.indexOf(hb)===-1)gb.specific_to_list.push(hb);if(!gb.thread_id){if(gb.specific_to_list.length==1){gb.thread_id='user:'+fb._fbid;}else if(gb.specific_to_list.length==2){var ib=gb.specific_to_list[0]==hb?gb.specific_to_list[1]:gb.specific_to_list[0];if(p.tokenize(ib).type=='email'){gb.thread_id=o.PENDING_THREAD_ID;}else gb.thread_id=fb._threads.getThreadIDForParticipant(ib);}gb.thread_id=gb.thread_id||'root:'+gb.message_id;}if(!gb.specific_to_list.length){var jb=fb._serverRequests.tokenizeThreadID(gb.thread_id);if(jb.type=='user')gb.specific_to_list=['fbid:'+jb.value,hb];}}function qa(fb,gb,hb,ib){var jb=bb(hb)?[s.CHAT]:[],kb=Date.now(),lb=ia(new Date(kb),'g:ia'),mb={action_type:gb,thread_id:ib,author:z.getIDForUser(fb._fbid),author_email:null,coordinates:null,timestamp:kb,timestamp_absolute:(new Date(kb)).toLocaleDateString(),timestamp_relative:lb,timestamp_time_passed:x.TODAY,is_unread:false,is_cleared:false,is_forward:false,is_filtered_content:false,is_spoof_warning:false,source:hb,source_tags:jb};return mb;}function ra(fb){switch(fb){case t.UNKNOWN:case t.SERVER_INITIAL_DATA:case t.SERVER_FETCH_THREAD_INFO:case t.SERVER_THREAD_SYNC:return true;}return false;}function sa(fb){return fb&&fb.substr(0,6)==='server';}function ta(fb,gb){if(!fb._threadsToMessages[gb])fb._threadsToMessages[gb]=new ba(function(hb){return na(fb,hb).timestamp;},function(hb,ib){return ib-hb;});return fb._threadsToMessages[gb];}function ua(fb){var gb=[];return JSON.stringify(fb,function(hb,ib){if(typeof ib==='object'&&ib!==null){if(ka(ib))return '<'+ib.nodeName+'>';if(gb.indexOf(ib)!==-1)return 'CIRCULAR';gb.push(ib);}return ib;});}ca.registerCallback('mercury-messages',function(){var fb={},gb={},hb=wa._getInstances();for(var ib in hb){fb[ib]={};for(var jb in hb[ib]._messages){var kb=hb[ib]._messages[jb];if(Object.keys(kb).length===0)continue;var lb=kb.thread_id;fb[ib][lb]=fb[ib][lb]||{};fb[ib][lb][kb.message_id]=JSON.parse(ua(kb));}gb[ib]=ga({},hb[ib]._localIdsMap);}var mb={};mb.local_message_ids=gb;mb.messages=fb;return mb;});function va(fb,gb,hb){gb.forEach(function(ib){var jb=ta(fb,ib);jb.setReachedEndOfArray();fb._threadInformer.reorderedMessages(ib,hb);});}function wa(fb){this._fbid=fb;this._serverRequests=da.getForFBID(this._fbid);this._threadInformer=ea.getForFBID(this._fbid);this._threads=fa.getForFBID(this._fbid);this._failedHistoryFetchThreads={};this._threadsToMessages={};this._titanMessagesCount={};this._localTitanMessagesCount={};this._messages={};this._attachmentData={};this._messagesNeedingAttachmentData={};this._localIdsMap={};this._serverRequests.subscribe('update-messages',function(gb,hb){var ib=(hb.actions||[]).filter(function(kb){var lb=kb.action_type;return (kb.is_forward||kb.thread_id)&&(lb==l.LOG_MESSAGE||lb==l.USER_GENERATED_MESSAGE||lb==l.SEND_MESSAGE||lb==l.CLEAR_CHAT||lb==l.DELETE_THREAD||lb==l.DELETE_MESSAGES);}),jb=ra(hb.payload_source);if(sa(hb.payload_source))ib.forEach(function(kb){if(!kb.is_forward){var lb=this._threads.getThreadMetaNow(kb.thread_id);if(lb)kb.is_cleared=kb.timestamp<lb.chat_clear_time;}}.bind(this));this.handleUpdates(ib,jb,hb.payload_source,hb.from_client);if(hb.end_of_history)va(this,hb.end_of_history,hb.payload_source);}.bind(this));}ga(wa.prototype,{getMessagesFromIDs:function(fb){return (fb||[]).map(na.bind(null,this)).filter(function(gb){return gb;});},hasLoadedNMessages:function(fb,gb){var hb=ta(this,fb);return hb.hasReachedEndOfArray()||hb.getCurrentArraySize()>=gb;},hasLoadedExactlyNMessages:function(fb,gb){var hb=ta(this,fb);return hb.getCurrentArraySize()==gb;},clearMercuryInternalState_DO_NOT_USE:function(){this._failedHistoryFetchThreads={};this._threadsToMessages={};this._titanMessagesCount={};this._localTitanMessagesCount={};this._messages={};this._attachmentData={};this._messagesNeedingAttachmentData={};this._localIdsMap={};},getThreadMessagesRange:function(fb,gb,hb,ib,jb,kb){var lb=ta(this,fb),mb=function(sb){ib(xa(this,sb));}.bind(this),nb=lb.executeOrEnqueue(gb,hb,mb),ob=lb.getUnavailableResources(nb),pb=this._failedHistoryFetchThreads[fb];if(ob.length&&!pb){var qb=(this._titanMessagesCount[fb]||0)-(this._localTitanMessagesCount[fb]||0),rb=ob.length+(this._localTitanMessagesCount[fb]||0);this._serverRequests.fetchThreadMessages(fb,qb,rb,jb,kb);}else this._failedHistoryFetchThreads[fb]=false;return nb;},getThreadMessagesSinceTimestamp:function(fb,gb){var hb=ta(this,fb),ib=hb.getElementsUntil(gb);return xa(this,ib);},hasLoadedAllMessages:function(fb){return ta(this,fb).hasReachedEndOfArray();},getCurrentlyLoadedMessages:function(fb){var gb=ta(this,fb).getAllResources();return xa(this,gb);},unsubscribe:function(fb,gb){m.isThreadID(gb);var hb=ta(this,gb);hb.unsubscribe(fb);},addAttachmentData:function(fb,gb,hb){var ib=na(this,fb);if(ib){var jb=ib.attachments.indexOf(gb);if(jb!=-1){ib.attachments[jb]=hb;this._threadInformer.updatedMessage(ib.thread_id,ib.message_id,'attach');}}else{if(!this._attachmentData[fb])this._attachmentData[fb]=[];this._attachmentData[fb].push({attach_key:gb,data:hb});}},shouldSortOutOfOrderMessages:function(fb,gb,hb){if(fb==t.CLIENT_CHANNEL_MESSAGE){var ib=this.getThreadMessagesSinceTimestamp(gb,hb);if(ib.length>0){h.bumpEntityKey('chat.web','channel.messages_reordered');return true;}}return false;},handleUpdates:function(fb,gb,hb,ib){var jb,kb={},lb={};for(var mb=0;mb<fb.length;mb++){var nb=fb[mb];if(nb.is_forward||hb==t.SERVER_SEARCH){if(!this._messages[nb.message_id]){this._messages[nb.message_id]=nb;cb(this,nb);}continue;}if(nb.client_state===r.SEND_TO_SERVER){this._messages[nb.message_id]=nb;cb(this,nb);continue;}var ob=nb.action_type;if(hb==t.CLIENT_CHANNEL_MESSAGE&&ob==l.USER_GENERATED_MESSAGE&&nb.threading_id&&this._localIdsMap[nb.threading_id]===nb.threading_id){nb.client_message_id=nb.threading_id;nb.status=k.SUCCESS;nb.action_type=l.SEND_MESSAGE;ob=nb.action_type;}if(ob==l.SEND_MESSAGE){var pb=nb.client_message_id;if(pb&&this._localIdsMap[pb]&&nb.status){var qb=na(this,pb),rb=qb.status;if(qb.status==k.SUCCESS)continue;if(nb.status==k.UNCONFIRMED){if(!lb[nb.thread_id])lb[nb.thread_id]=[];lb[nb.thread_id].push(pb);}else if(!kb[nb.thread_id])kb[nb.thread_id]=[];this.updateLocalMessage(nb,hb);if(typeof rb!==undefined||nb.status==k.FAILED_UNKNOWN_REASON||nb.status==k.UNABLE_TO_CONFIRM||nb.status==k.SUCCESS||nb.status==k.ERROR)this._threadInformer.updatedMessage(nb.thread_id,na(this,pb).message_id,hb);}continue;}else if(ob==l.DELETE_THREAD){ta(this,nb.thread_id).removeAllResources();continue;}else if(ob==l.DELETE_MESSAGES){var sb=nb.message_ids.map(function(zb){return na(this,zb).message_id;}.bind(this));jb=ta(this,nb.thread_id);jb.removeResources(sb);this._threadInformer.reorderedMessages(nb.thread_id,hb);continue;}else if(ob==l.LOG_MESSAGE){if(nb.log_message_type==q.SERVER_ERROR)this._failedHistoryFetchThreads[nb.thread_id]=true;}else if(ob==l.CLEAR_CHAT){var tb=ta(this,nb.thread_id).getAllResources();tb.map(na.bind(null,this)).forEach(function(zb){zb.is_cleared=true;});continue;}var ub=na(this,nb.message_id);if((nb.threading_id&&this._localIdsMap[nb.threading_id])||(ub&&!ub.is_forward))continue;if(!kb[nb.thread_id])kb[nb.thread_id]=[];kb[nb.thread_id].push(nb.message_id);this._messages[nb.message_id]=nb;cb(this,nb);if(nb.threading_id&&nb.threading_id!=nb.message_id)y.addServerID(nb.threading_id,nb.message_id);gb=gb||this.shouldSortOutOfOrderMessages(hb,nb.thread_id,nb.timestamp);if(!gb)this._threadInformer.receivedMessage(nb);}for(var vb in kb){jb=ta(this,vb);var wb=jb.getAllResources(),xb=wb.filter(function(zb){var ac=this._messages[zb];return ac.action_type==l.LOG_MESSAGE&&ac.log_message_type==q.SERVER_ERROR;}.bind(this));jb.removeResources(xb);ya(this,vb,kb[vb]);if(ib)za(this,vb,kb[vb]);if(gb){jb.addResources(kb[vb]);this._threadInformer.reorderedMessages(vb,hb);}else jb.addResourcesWithoutSorting(kb[vb].reverse(),0);this._threadInformer.updatedThread(vb);}var yb=Object.keys(lb);if(yb.length)this._serverRequests.requestMessageConfirmation(lb);},sendMessage:function(fb,gb,hb){var event=u.CLIENT_SEND_ATTEMPTED;if(fb.status===k.RESENDING)event=u.CLIENT_RESEND_ATTEMPTED;var ib=false;if(p.isValid(fb.thread_id))ib=!p.isMultichat(fb.thread_id);setTimeout(function(){u.log(event,fb.message_id,{canonical:ib});},0);gb=gb||Function.prototype;pa(this,fb);this._localIdsMap[fb.message_id]=fb.message_id;if(fb.thread_id=='root:'+fb.message_id)ta(this,fb.thread_id).setReachedEndOfArray();this._serverRequests.sendNewMessage(fb,hb);if(fb.thread_id==o.PENDING_THREAD_ID){this._messages[fb.message_id]=fb;return oa.executeOrEnqueue(fb.message_id,gb);}else gb(fb.thread_id);},isOutbound:function(fb){return fb.author==z.user;},isInbound:function(fb){return !this.isOutbound(fb);},isSending:function(fb){return (fb.status===k.UNSENT||fb.status===k.UNCONFIRMED||fb.status===k.UNABLE_TO_CONFIRM||fb.status===k.RESENDING);},isFirstMessage:function(fb){var gb=ta(this,fb.thread_id);if(gb.getCurrentArraySize()===0)return false;var hb=gb.getResourceAtIndex(gb.getCurrentArraySize()-1),ib=na(this,hb).message_id,jb=na(this,fb.message_id).message_id;return gb.hasReachedEndOfArray()&&ib==jb;},unsubscribeSend:function(fb){oa.unsubscribe(fb);},resendMessage:function(fb,gb){var hb=ga({},fb);hb.status=k.RESENDING;hb.timestamp=Date.now();hb.message_id=fb.message_id;this._messages[fb.message_id]=hb;var ib=ta(this,fb.thread_id);ib.resortResources([fb.message_id]);this.sendMessage(hb,null,gb);this._threadInformer.reorderedMessages(fb.thread_id,t.CLIENT_SEND_MESSAGE);},deleteMessages:function(fb,gb){if(gb.length){var hb=ta(this,fb),ib=hb.getCurrentArraySize()==gb.length&&hb.hasReachedEndOfArray();this._serverRequests.deleteMessages(fb,gb,ib);}},deleteLocalMessage:function(fb){if(this._localTitanMessagesCount[fb])this._localTitanMessagesCount[fb]--;},markMessagesSpam:function(fb,gb){if(gb.length){var hb=ta(this,fb),ib=hb.getCurrentArraySize()==gb.length&&hb.hasReachedEndOfArray();if(ib){this._serverRequests.markThreadSpam(fb);}else this._serverRequests.markMessagesSpam(fb,gb);}},updateLocalMessage:function(fb,gb){var hb=na(this,fb.client_message_id);hb.status=fb.status;if(fb.status===k.SUCCESS||fb.error_data)hb.error_data=fb.error_data;var ib=fb.message_id,jb=fb.client_message_id;if(this._messages[ib])return false;this._localIdsMap[jb]=ib;this._messages[ib]=this._messages[jb];y.addServerID(jb,ib);this._messages[jb]={};var kb=na(this,jb);if(fb.timestamp)kb.timestamp=fb.timestamp;if(fb.attachments&&fb.attachments.length){kb.raw_attachments=null;kb.attachments=fb.attachments;cb(this,kb,ib);}if(fb.log_message_data)kb.log_message_data=fb.log_message_data;if(ab(kb))this._localTitanMessagesCount[kb.thread_id]--;return true;},constructUserGeneratedMessageObject:function(fb,gb,hb,ib,jb){var kb=qa(this,l.USER_GENERATED_MESSAGE,gb,hb);if(typeof fb=='string')fb=fb.replace(/^\s+/,'').replace(/\s+$/,'');kb.body=fb;kb.has_attachment=false;kb.html_body=false;kb.attachments=[];kb.specific_to_list=ib||[];kb.creator_info=jb;return kb;},constructLogMessageObject:function(fb,gb,hb,ib){var jb=qa(this,l.LOG_MESSAGE,fb,gb);jb.log_message_type=hb;jb.log_message_data=ib;return jb;},generateNewClientMessageID:function(fb){var gb=fb+':'+(la(0,4294967295)+1)+'-'+aa.getSessionID();return '<'+gb+'@mail.projektitan.com>';},getNumberLocalMessages:function(fb){return this._localTitanMessagesCount[fb]||0;},_uploadMessages:{},updateNewMessage:function(fb,gb,hb){if(hb.preview_attachments.length>0){fb.has_attachment=true;fb.preview_attachments=hb.preview_attachments;}fb.client_state=r.DO_NOT_SEND_TO_SERVER;fb.status=k.RESENDING;this._uploadMessages[gb]=fb;return fb;},updateMessageAfterUpload:function(fb,gb){var hb=this._uploadMessages[fb];ja(hb);hb.image_ids=gb.image_ids;hb.client_state=r.SEND_TO_SERVER;return hb;},clearUploadedMessage:function(fb){delete this._uploadMessages[fb];}});ga(wa,v,{addAttachmentData:function(fb,gb,hb,ib){ib=ib||i.getID();wa.getForFBID(ib).addAttachmentData(fb,gb,hb);}});function xa(fb,gb){var hb=gb.map(na.bind(null,fb));return hb.reverse();}function ya(fb,gb,hb){var ib=hb.filter(function(jb){return ab(na(fb,jb));});if(!fb._titanMessagesCount[gb])fb._titanMessagesCount[gb]=0;fb._titanMessagesCount[gb]+=ib.length;}function za(fb,gb,hb){var ib=hb.filter(function(jb){return ab(na(fb,jb));});if(!fb._localTitanMessagesCount[gb])fb._localTitanMessagesCount[gb]=0;fb._localTitanMessagesCount[gb]+=ib.length;}function ab(fb){var gb=fb.action_type;if(gb==l.USER_GENERATED_MESSAGE)return true;switch(fb.log_message_type){case q.SUBSCRIBE:case q.UNSUBSCRIBE:case q.SERVER_ERROR:case q.LIVE_LISTEN:return false;default:return true;}}function bb(fb){switch(fb){case w.CHAT_WEB:case w.CHAT_JABBER:case w.CHAT_IPHONE:case w.CHAT_MEEBO:case w.CHAT_ORCA:case w.CHAT_TEST:case w.CHAT:case w.DESKTOP:return true;default:return false;}}function cb(fb,gb,hb){hb=hb||gb.message_id;var ib=fb._attachmentData[hb];if(ib){ib.forEach(function(jb){var kb=gb.attachments.indexOf(jb.attach_key);if(kb!==-1)gb.attachments[kb]=jb.data;});delete fb._attachmentData[hb];}else if(!gb.is_forward&&db(fb,gb)){fb._messagesNeedingAttachmentData[hb]=true;eb(fb);}}function db(fb,gb){if(!gb||!gb.attachments)return false;for(var hb=0;hb<gb.attachments.length;hb++){var ib=gb.attachments[hb];if(typeof ib==='string'&&ib.indexOf(n.SHARE)===0)return true;}var jb=gb.forward_message_ids||[];for(hb=0;hb<jb.length;hb++){var kb=na(fb,jb[hb]);if(db(fb,kb))return true;}return false;}var eb=ha(function(fb){var gb={};for(var hb in fb._messagesNeedingAttachmentData){var ib=na(fb,hb);if(db(fb,ib))gb[hb]=true;}var jb=Object.keys(gb);if(jb.length){var kb={message_ids:jb};if(fb._fbid!=i.getID())kb.request_user_id=fb._fbid;new g('/ajax/mercury/attachments/fetch_shares.php').setData(kb).setAllowCrossPageTransition(true).send();}fb._messagesNeedingAttachmentData={};},0,this);e.exports=wa;},null);
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","MercuryActionTypeConstants","MercuryConfig","MercuryGlobalActionType","MercuryPayloadSource","MercurySendLogger","MessagingReliabilityLogger","MessagingEvent","MessagingTag","MercuryParticipants","PresenceUtil","copyProperties","MercuryMessages","MercuryServerRequests","MercuryThreadInformer"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=b('MercuryMessages').get(),u=b('MercuryServerRequests').get(),v=b('MercuryThreadInformer').get();function w(bb,cb){if(j.MercuryFBIDGK){y(bb,cb);}else x(bb,cb);}function x(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.message){n.addEntry('channel_receive','invalid_data');return;}var db=cb.obj.message,eb={author:db.mercury_author_id,author_email:db.mercury_author_email,body:db.body,subject:db.subject,has_attachment:db.has_attachment,attachments:db.attachments,html_body:db.html_body,thread_id:db.tid,message_id:db.mid,coordinates:db.mercury_coordinates,is_spoof_warning:db.is_spoof_warning,source:db.mercury_source,source_tags:db.mercury_source_tags,threading_id:db.threading_id,timestamp:db.timestamp,timestamp_absolute:db.timestamp_absolute,timestamp_relative:db.timestamp_relative,timestamp_time_passed:db.timestamp_time_passed,action_type:i.USER_GENERATED_MESSAGE,is_unread:db.is_unread,action_id:db.action_id,is_forward:false,forward_count:db.forward_count||db.forward,forward_message_ids:db.forward_msg_ids,location_text:db.location_text,folder:cb.obj.folder};if("sync_id" in db){eb.sync_id=db.sync_id;}else eb.action_id=db.action_id;var fb=[s({},eb)];fb=fb.concat(db.forward_actions||[]);var gb=l.CLIENT_CHANNEL_MESSAGE;u.handleUpdateWaitForThread({actions:fb,payload_source:gb},db.tid);if(!db.is_unread&&db.mercury_author_id===q.user){var hb={};hb[db.tid]=cb.obj.folder;z(h.getArbiterType('messaging'),{obj:{event:o.READ,tids:[db.tid],folder_info:hb,timestamp:db.timestamp}});}if(db.mercury_author_id===q.user)if(t.getMessagesFromIDs([db.threading_id]).length)m.log(m.CLIENT_CHANNEL_ECHO,db.threading_id,{canonical:!db.group_thread_info});n.addEntry('channel_receive','success',[eb.thread_id,eb.message_id,r.getSessionID()]);}function y(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.message){n.addEntry('channel_receive','invalid_data');return;}var db=cb.obj.message,eb=db.other_user_fbid?db.other_user_fbid:db.thread_fbid,fb={author:db.mercury_author_id,author_email:db.mercury_author_email,body:db.body,subject:db.subject,has_attachment:db.has_attachment,attachments:db.attachments,html_body:db.html_body,thread_id:db.tid,thread_fbid:db.thread_fbid,other_user_fbid:db.other_user_fbid,message_id:db.mid,coordinates:db.mercury_coordinates,is_spoof_warning:db.is_spoof_warning,source:db.mercury_source,source_tags:db.mercury_source_tags,threading_id:db.threading_id,timestamp:db.timestamp,timestamp_absolute:db.timestamp_absolute,timestamp_relative:db.timestamp_relative,timestamp_time_passed:db.timestamp_time_passed,action_type:i.USER_GENERATED_MESSAGE,is_unread:db.is_unread,is_forward:false,forward_count:db.forward_count||db.forward,forward_message_ids:db.forward_msg_ids,location_text:db.location_text,folder:cb.obj.folder};if("sync_id" in db){fb.sync_id=db.sync_id;}else fb.action_id=db.action_id;var gb=[s({},fb)];gb=gb.concat(db.forward_actions||[]);var hb=l.CLIENT_CHANNEL_MESSAGE;u.handleUpdateWaitForThread({actions:gb,payload_source:hb},eb);if(!db.is_unread&&db.mercury_author_id===q.user){var ib={};ib[eb]=cb.obj.folder;z(h.getArbiterType('messaging'),{obj:{event:o.READ,thread_fbids:db.thread_fbid?[db.thread_fbid]:[],other_user_fbids:db.other_user_fbid?[db.other_user_fbid]:[],folder_info:ib,timestamp:db.timestamp}});}if(db.mercury_author_id===q.user)if(t.getMessagesFromIDs([db.threading_id]).length)m.log(m.CLIENT_CHANNEL_ECHO,db.threading_id,{canonical:!db.group_thread_info});n.addEntry('channel_receive','success',[eb,fb.message_id,r.getSessionID()]);}function z(bb,cb){if(j.MercuryFBIDGK){ba(bb,cb);}else aa(bb,cb);}function aa(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.tids)return;var db=[],eb=cb.obj.event==o.READ;(cb.obj.tids||[]).forEach(function(fb){db.push({action_type:i.CHANGE_READ_STATUS,action_id:null,thread_id:fb,mark_as_read:eb,timestamp:cb.obj.timestamp||0,folder:cb.obj.folder_info[fb]});});u.handleUpdate({actions:db,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ba(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||(!cb.obj.thread_fbids&&!cb.obj.other_user_fbids))return;var db=[],eb=cb.obj.event==o.READ;(cb.obj.thread_fbids||[]).forEach(function(fb){db.push({action_type:i.CHANGE_READ_STATUS,action_id:null,thread_fbid:fb,mark_as_read:eb,timestamp:cb.obj.timestamp||0,folder:cb.obj.folder_info[fb]});});(cb.obj.other_user_fbids||[]).forEach(function(fb){db.push({action_type:i.CHANGE_READ_STATUS,action_id:null,other_user_fbid:fb,mark_as_read:eb,timestamp:cb.obj.timestamp||0,folder:cb.obj.folder_info[fb]});});u.handleUpdate({actions:db,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ca(bb,cb){if(j.MercuryFBIDGK){ea(bb,cb);}else da(bb,cb);}function da(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.tids)return;var db=[];(cb.obj.tids||[]).forEach(function(eb){db.push({action_type:i.DELETE_THREAD,action_id:null,thread_id:eb});});u.handleUpdate({actions:db,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ea(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!(cb.obj.thread_fbids||cb.obj.other_user_fbids))return;var db=[];(cb.obj.thread_fbids||[]).forEach(function(eb){db.push({action_type:i.DELETE_THREAD,action_id:null,thread_fbid:eb});});(cb.obj.other_user_fbids||[]).forEach(function(eb){db.push({action_type:i.DELETE_THREAD,action_id:null,other_user_fbid:eb});});u.handleUpdate({actions:db,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function fa(bb,cb){if(j.MercuryFBIDGK){ha(bb,cb);}else ga(bb,cb);}function ga(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.tids||!cb.obj.mids)return;var db=cb.obj.tids[0],eb={action_type:i.DELETE_MESSAGES,action_id:null,thread_id:db,message_ids:cb.obj.mids};u.handleUpdate({actions:[eb],threads:[cb.obj.updated_thread],payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ha(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||(!cb.obj.thread_fbids&&!cb.obj.other_user_fbids)||!cb.obj.mids)return;var db=cb.obj.thread_fbids.length?cb.obj.thread_fbids[0]:null,eb=cb.obj.other_user_fbids.length?cb.obj.other_user_fbids[0]:null,fb={action_type:i.DELETE_MESSAGES,action_id:null,thread_fbid:db,other_user_fbid:eb,message_ids:cb.obj.mids};u.handleUpdate({actions:[fb],threads:[cb.obj.updated_thread],payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ia(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||!cb.obj.folder)return;var db={action_type:k.MARK_ALL_READ,action_id:cb.obj.action_id,folder:cb.obj.folder};u.handleUpdate({global_actions:[db]});}function ja(bb,cb){if(j.MercuryFBIDGK){la(bb,cb);}else ka(bb,cb);}function ka(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj.tids)return;var db=l.CLIENT_CHANNEL_MESSAGE;(cb.obj.tids||[]).forEach(function(eb){var fb={action_type:i.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:eb,archived:cb.obj.state};u.handleUpdateWaitForThread({actions:[s({},fb)],payload_source:db},eb);});}function la(bb,cb){if(bb!=h.getArbiterType('messaging')||(!cb.obj.thread_fbids&&!cb.obj.other_user_fbids))return;var db=l.CLIENT_CHANNEL_MESSAGE;(cb.obj.thread_fbids||[]).forEach(function(eb){var fb={action_type:i.CHANGE_ARCHIVED_STATUS,action_id:null,thread_fbid:eb,other_user_fbid:null,archived:cb.obj.state};u.handleUpdateWaitForThread({actions:[s({},fb)],payload_source:db},eb);});(cb.obj.other_user_fbids||[]).forEach(function(eb){var fb={action_type:i.CHANGE_ARCHIVED_STATUS,action_id:null,thread_fbid:null,other_user_fbid:eb,archived:cb.obj.state};u.handleUpdateWaitForThread({actions:[s({},fb)],payload_source:db},eb);});}function ma(bb,cb){if(j.MercuryFBIDGK){oa(bb,cb);}else na(bb,cb);}function na(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj.tids)return;var db=l.CLIENT_CHANNEL_MESSAGE,eb;(cb.obj.tids||[]).forEach(function(fb){if(cb.obj.event==o.TAG){eb=cb.obj.tag;}else eb=cb.obj.marked_as_spam?p.SPAM:p.INBOX;var gb={action_type:i.CHANGE_FOLDER,action_id:null,thread_id:fb,new_folder:eb};u.handleUpdateWaitForThread({actions:[s({},gb)],payload_source:db},fb);});}function oa(bb,cb){if(bb!=h.getArbiterType('messaging')||(!cb.obj.thread_fbids&&!cb.obj.other_user_fbids))return;var db=l.CLIENT_CHANNEL_MESSAGE,eb;(cb.obj.thread_fbids||[]).forEach(function(fb){if(cb.obj.event==o.TAG){eb=cb.obj.tag;}else eb=cb.obj.marked_as_spam?p.SPAM:p.INBOX;var gb={action_type:i.CHANGE_FOLDER,action_id:null,thread_fbid:fb,other_user_fbid:null,new_folder:eb};u.handleUpdateWaitForThread({actions:[s({},gb)],payload_source:db},fb);});(cb.obj.other_user_fbids||[]).forEach(function(fb){if(cb.obj.event==o.TAG){eb=cb.obj.tag;}else eb=cb.obj.marked_as_spam?p.SPAM:p.INBOX;var gb={action_type:i.CHANGE_FOLDER,action_id:null,other_user_fbid:fb,thread_fbid:null,new_folder:eb};u.handleUpdateWaitForThread({actions:[s({},gb)],payload_source:db},fb);});}function pa(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj.tag)return;switch(cb.obj.tag){case p.ACTION_ARCHIVED:ja(bb,cb);break;case p.INBOX:case p.OTHER:ma(bb,cb);break;}}function qa(bb,cb){if(j.MercuryFBIDGK){sa(bb,cb);}else ra(bb,cb);}function ra(bb,cb){if(bb!=h.getArbiterType('inbox')||!cb.obj||!cb.obj.seen_timestamp)return;u.handleUpdate({message_counts:[{seen_timestamp:cb.obj.seen_timestamp,folder:p.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:p.INBOX}],payload_source:l.CLIENT_CHANNEL_MESSAGE});}function sa(bb,cb){if(bb!=h.getArbiterType('inbox')||!cb.obj||!cb.obj.seen_timestamp)return;u.handleUpdate({message_counts:[{seen_timestamp:cb.obj.seen_timestamp,folder:p.INBOX}],unseen_thread_fbids:[{thread_fbids:[],other_user_fbids:[],folder:p.INBOX}],payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ta(bb,cb){if(bb!=h.getArbiterType('mercury')||!cb.obj)return;v.synchronizeInforms(function(){var db=cb.obj,eb=[];(db.actions||[]).forEach(function(fb){var gb=i.USER_GENERATED_MESSAGE;if(fb.action_type==i.LOG_MESSAGE){var hb=l.CLIENT_CHANNEL_MESSAGE,ib;if(j.MercuryFBIDGK){ib=fb.other_user_fbid||fb.thread_fbid;}else ib=fb.thread_id;u.handleUpdateWaitForThread({actions:[s({},fb)],payload_source:hb},ib);}else if(fb.action_type!=gb)eb.push(fb);});db.actions=eb;db.payload_source=l.CLIENT_CHANNEL_MESSAGE;u.handleUpdate(db);});}function ua(bb,cb){u.handleRoger(cb.obj);}function va(bb,cb){if(j.MercuryFBIDGK){xa(bb,cb);}else wa(bb,cb);}function wa(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||cb.obj.mute_settings===undefined||!cb.obj.thread_id)return;var db=i.CHANGE_MUTE_SETTINGS,eb=[{action_type:db,action_id:null,thread_id:cb.obj.thread_id,mute_settings:cb.obj.mute_settings}];u.handleUpdate({actions:eb,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function xa(bb,cb){if(bb!=h.getArbiterType('messaging')||!cb.obj||cb.obj.mute_settings===undefined||(!cb.obj.thread_fbid&&!cb.obj.other_user_fbid))return;var db=i.CHANGE_MUTE_SETTINGS,eb=[{action_type:db,action_id:null,thread_fbid:cb.obj.thread_fbid,other_user_fbid:cb.obj.other_user_fbid,mute_settings:cb.obj.mute_settings}];u.handleUpdate({actions:eb,payload_source:l.CLIENT_CHANNEL_MESSAGE});}function ya(bb,cb){switch(cb.obj.event){case o.DELIVER:w(bb,cb);break;case o.READ:case o.UNREAD:z(bb,cb);break;case o.READ_ALL:ia(bb,cb);break;case o.DELETE:ca(bb,cb);break;case o.DELETE_MESSAGES:fa(bb,cb);break;case o.TAG:pa(bb,cb);break;case o.REPORT_SPAM:ma(bb,cb);break;case o.READ_RECEIPT:ua(bb,cb);break;case o.CHANGE_MUTE_SETTINGS:va(bb,cb);break;}}var za=[],ab={turnOn:function(){if(!za.length){var bb={mercury:ta,messaging:ya,inbox:qa};for(var cb in bb)za.push(g.subscribe(h.getArbiterType(cb),bb[cb]));}},turnOff:function(){if(za.length){za.forEach(g.unsubscribe);za=[];}}};ab.turnOn();e.exports=ab;},null);
__d("MercuryRoger",["Arbiter","ArbiterMixin","JSLogger","MercuryActionStatus","copyProperties","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f,g,h,i,j,k){var l=b('MercuryServerRequests').get(),m=b('MercuryThreads').get(),n={},o=[],p={getSeenBy:function(q,r){if(!q)return [];var s=[],t=n[q.thread_id],u=j.SUCCESS;for(var v in t)if(t[v]>q.timestamp&&(q.status===undefined||q.status===u)&&(!r||v!=q.author))s.push(v);return s;},getSeenTimestamp:function(q,r){var s=n[q];return s?s[r]:null;}};k(p,h);l.subscribe('update-roger',function(q,r){for(var s in r){if(!n[s])n[s]={};for(var t in r[s]){var u=m.getThreadMetaNow(s);if(u&&u.participants)if(u.participants.indexOf(t)==-1){o.push(n);continue;}var v=n[s][t],w=r[s][t];if(!v||w>v)n[s][t]=w;}}if(r)p.inform('state-changed',r);});g.subscribe(i.DUMP_EVENT,function(q,r){r.bad_read_receipts={receipts:o};});e.exports=p;},null);
__d("MercuryDelayedRoger",["ArbiterMixin","LiveTimer","MercuryActionStatus","MercuryConfig","MercuryRoger","copyProperties","setTimeoutAcrossTransitions","MercuryMessages","MercuryThreadInformer","MercuryThreads"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=b('MercuryMessages').get(),o=b('MercuryThreadInformer').get(),p=b('MercuryThreads').get(),q={},r={},s=j['roger.seen_delay'],t=l({getSeenBy:function(x,y){if(r[x])return [];if(!q[x]){var z=p.getThreadMetaNow(x);if(z)q[x]={thread_id:x,author:z.participants[0],timestamp:z.timestamp};}return k.getSeenBy(q[x],y);}},g);function u(x){var y=false;n.getThreadMessagesRange(x,0,1,function(z){var aa=z[0];if(!aa)return;var ba=aa.timestamp;if(aa.action_id||aa.status==i.SUCCESS)ba-=h.getServerTimeOffset();var ca=t.getSeenBy(x);if(r[x]){clearTimeout(r[x]);delete r[x];}var da=ba+s,ea=da-Date.now();if(ea>0)r[x]=m(function(){delete r[x];v(x);},ea);q[x]=aa;var fa=t.getSeenBy(x);if(ca.length||fa.length)y=true;});return y;}function v(x){var y={};y[x]=true;t.inform('state-changed',y);}function w(event,x){var y={};for(var z in x)if(u(z))y[z]=true;for(var aa in y){t.inform('state-changed',y);break;}}k.subscribe('state-changed',function(x,y){for(var z in y)!r[z]&&v(z);});o.subscribe('messages-received',w);o.subscribe('messages-reordered',w);o.subscribe('messages-updated',w);e.exports=t;},null);
__d("MercuryUnseenState",["KeyedCallbackManager","LogHistory","MercuryActionTypeConstants","MercuryConfig","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMuter","MercuryThreads","copyProperties","createObjectFrom","isEmpty"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){var v=l.MAX_UNSEEN_COUNT,w='unseen_thread_hash',x='unseen_thread_list',y=h.getInstance('mercury_unseen_state');function z(oa){this._fbid=oa;this._serverRequests=o.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._threadInformer=p.getForFBID(this._fbid);this._initialUnseenCount=null;this._lastSeenTimestamp=0;this._maxCount=false;this._unseenResources=new g();this._serverRequests.subscribe('update-unseen',function(pa,qa){ea(this,qa);}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(pa,qa){ma(this,qa);}.bind(this));}s(z.prototype,{getUnseenCount:function(){if(this.exceedsMaxCount()){y.error('unguarded_unseen_count_fetch',{});return 0;}return da(this)||0;},exceedsMaxCount:function(){return this._maxCount||(da(this)>v);},markAsSeen:function(){var oa=da(this);if(oa===null||oa>0||this._maxCount){this._serverRequests.markSeen();var pa=this._serverRequests.getLastActionTimestamp();ha(this,pa,[]);}},markThreadSeen:function(oa,pa){var qa={};qa[oa]=0;ja(this,qa,pa);}});s(z,k);function aa(oa,pa){oa._unseenResources.setResource(w,pa);oa._unseenResources.setResource(x,Object.keys(pa));}function ba(oa,pa){var qa=oa._unseenResources.executeOrEnqueue(w,pa),ra=oa._unseenResources.getUnavailableResources(qa);if(ra.length)oa._serverRequests.fetchUnseenThreadIDs();}function ca(oa){return oa._unseenResources.getResource(w);}function da(oa){var pa=oa._unseenResources.getResource(x);if(pa){return pa.length;}else return oa._initialUnseenCount;}function ea(oa,pa){if(j.MercuryFBIDGK){ga(oa,pa);}else fa(oa,pa);}function fa(oa,pa){var qa=na(pa);if(pa.unseen_thread_ids){pa.unseen_thread_ids.forEach(function(bb){if(bb.folder!=m.INBOX)return;var cb=la(oa,bb.thread_ids),db=oa._lastSeenTimestamp;if(qa&&qa.seen_timestamp)db=qa.seen_timestamp;ha(oa,db,cb);if(qa&&qa.unseen_count>v)oa._maxCount=true;});}else if(qa&&qa.seen_timestamp){oa._lastSeenTimestamp=qa.seen_timestamp;if(qa.unseen_count>v){oa._maxCount=true;aa(oa,{});}else{oa._initialUnseenCount=qa.unseen_count;if(oa._initialUnseenCount===0)aa(oa,{});}}else{if(oa._maxCount)return;var ra=pa.actions;if(!ra||!(ra.length))return;var sa={},ta={};for(var ua=0;ua<ra.length;ua++){var va=ra[ua];if(va.is_forward)continue;var wa=va.action_type,xa=va.thread_id?va.thread_id:va.server_thread_id,ya=va.folder===undefined||va.folder==m.INBOX;if(!ya)continue;if(wa==i.USER_GENERATED_MESSAGE||wa==i.LOG_MESSAGE){var za=sa[xa]?va.timestamp>sa[xa]:false,ab=za||!sa[xa];if(va.is_unread&&ab)oa._threads.getThreadMeta(xa,function(bb){var cb=false;if(bb&&bb.last_read_timestamp)if(bb.last_read_timestamp>=va.timestamp)cb=true;if(!q.isThreadMuted(bb)&&!cb)sa[xa]=va.timestamp;});}else if(wa==i.CHANGE_READ_STATUS&&va.mark_as_read)ta[xa]=va.timestamp;}ia(oa,sa);ja(oa,ta);}}function ga(oa,pa){var qa=na(pa);if(pa.unseen_thread_fbids){pa.unseen_thread_fbids.forEach(function(cb){if(cb.folder!=m.INBOX)return;var db=cb.thread_fbids||[];db=db.concat(cb.other_user_fbids||[]);var eb=la(oa,db),fb=oa._lastSeenTimestamp;if(qa&&qa.seen_timestamp)fb=qa.seen_timestamp;ha(oa,fb,eb);if(qa&&qa.unseen_count>v)oa._maxCount=true;});}else if(qa&&qa.seen_timestamp){oa._lastSeenTimestamp=qa.seen_timestamp;if(qa.unseen_count>v){oa._maxCount=true;aa(oa,{});}else{oa._initialUnseenCount=qa.unseen_count;if(oa._initialUnseenCount===0)aa(oa,{});}}else{if(oa._maxCount)return;var ra=pa.actions;if(!ra||!(ra.length))return;var sa={},ta={};for(var ua=0;ua<ra.length;ua++){var va=ra[ua];if(va.is_forward)continue;var wa=va.action_type,xa=va.other_user_fbid?va.other_user_fbid:va.thread_fbid,ya=va.thread_id?va.thread_id:xa,za=va.folder===undefined||va.folder==m.INBOX;if(!za)continue;if(wa==i.USER_GENERATED_MESSAGE||wa==i.LOG_MESSAGE){var ab=sa[ya]?va.timestamp>sa[ya]:false,bb=ab||!sa[ya];if(va.is_unread&&bb)oa._threads.getThreadMeta(ya,function(cb){var db=false;if(cb&&cb.last_read_timestamp)if(cb.last_read_timestamp>=va.timestamp)db=true;if(!q.isThreadMuted(cb)&&!db)sa[ya]=va.timestamp;});}else if(wa==i.CHANGE_READ_STATUS&&va.mark_as_read)ta[ya]=va.timestamp;}ia(oa,sa);ja(oa,ta);}}function ha(oa,pa,qa){var ra=ca(oa);if(ra===undefined||pa>oa._lastSeenTimestamp||oa._maxCount){oa._lastSeenTimestamp=pa;qa=qa||[];if(qa.length<=v)oa._maxCount=false;var sa={},ta=ca(oa)||{};for(var ua in ta)if(ta[ua]!==true){var va=ta[ua];if(ka(oa,va))sa[ua]=va;}var wa=s(t(qa,true),sa);aa(oa,wa);oa._threadInformer.updatedUnseenState();}}function ia(oa,pa){if(oa._maxCount)return;var qa={},ra=false;for(var sa in pa){var ta=pa[sa];if(ka(oa,ta)){qa[sa]=ta;ra=true;}}if(!ra)return;ba(oa,function(ua){for(var va in qa){var wa=qa[va];if(!ua[va]&&ka(oa,wa))ua[va]=qa[va];}aa(oa,ua);oa._threadInformer.updatedUnseenState();});}function ja(oa,pa,qa){var ra=false;if(!u(pa))ra=true;if(ra)ba(oa,function(sa){var ta=false;for(var ua in pa){var va=pa[ua],wa=va>sa[ua];if(sa[ua]&&(!va||wa)){delete sa[ua];ta=true;}}if(ta){aa(oa,sa);oa._threadInformer.updatedUnseenState();if(qa&&da(oa)===0)oa._serverRequests.markSeen();}});}function ka(oa,pa){return pa>oa._lastSeenTimestamp;}function la(oa,pa){return pa.map(oa._serverRequests.convertThreadIDIfAvailable,oa._serverRequests);}function ma(oa,pa){var qa=ca(oa);if(!qa)return;for(var ra in pa){var sa=pa[ra];if(qa[ra]){qa[sa]=qa[ra];delete qa[ra];}}aa(oa,qa);}function na(oa){var pa=(oa.message_counts||[]);for(var qa=0;qa<pa.length;qa++)if(pa[qa].folder==m.INBOX)return pa[qa];return null;}n.registerCallback('mercury-unseen-state',function(){var oa={};oa.unseen={};oa.unseen_max_count={};oa.unseen_time={};var pa=z._getInstances();for(var qa in pa){oa.unseen[qa]=s({},ca(pa[qa]));oa.unseen_max_count[qa]=pa[qa]._maxCount;oa.unseen_time[qa]=pa[qa]._lastSeenTimestamp;}return oa;});e.exports=z;},null);
__d("MercuryThreadMetadataRawRenderer",["Event","CSS","DOM","MercuryActionStatus","MercuryErrorInfo","MessagingTag","MercuryStatusTemplates","Tooltip","URI","WebMessengerPermalinkConstants","WWWBase","cx","tx","fbt"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u={renderParticipantListWithNoThreadName:function(w,x,y,z,aa,ba){var ca={callback:true,check_length:true,show_unread_count:true};ba=ba||{};var da={};for(var ea in ba)if(ca[ea]){da[ea]=ba[ea];delete ba[ea];}var fa=y.map(function(ka){return z[ka];}),ga=this.renderRawParticipantList(w,fa,y.length,ba);ga=this.renderRawTitleWithUnreadCount(ga,da.show_unread_count?x.unread_count:0);var ha=ba.abbr_mode,ia={};for(var ja in ba)ia[ja]=ba[ja];ia.abbr_mode=true;aa.forEach(function(ka){var la=aa.length>1?this._cloneIfDOMElement(ga):ga;i.setContent(ka,la);if(da.check_length&&!ha&&ka.scrollWidth>ka.clientWidth){var ma=this.renderRawParticipantList(w,fa,y.length,ia),na=this.renderRawTitleWithUnreadCount(ma,da.show_unread_count?x.unread_count:0);i.setContent(ka,na);}}.bind(this));da.callback&&da.callback(ga);},renderRawParticipantList:function(w,x,y,z){var aa={abbr_mode:true,last_separator_uses_and:true,names_renderer:true};z=z||{};var ba=null;if(z.names_renderer){ba=z.names_renderer(x);}else ba=x.map(function(ea){return ea.name;});var ca=null;if(ba.length===0){if(!w){ca="New Message";}else ca="No Participants";}else if(ba.length==1){ca=ba[0];}else if(ba.length==2){var da={participant1:ba[0],participant2:ba[1]};if(z.last_separator_uses_and){ca=s._("{participant1} and {participant2}",da);}else ca=s._("{participant1}, {participant2}",da);}else if(z.last_separator_uses_and){if(z.abbr_mode){ca=s._("{participant1} and {others_link}",{participant1:ba[0],others_link:this.renderRawParticipantCount(w,{render_subset:true,count:y-1})});}else if(ba.length==3){ca=s._("{participant1}, {participant2} and {participant3}",{participant1:ba[0],participant2:ba[1],participant3:ba[2]});}else ca=s._("{participant1}, {participant2} and {others_link}",{participant1:ba[0],participant2:ba[1],others_link:this.renderRawParticipantCount(w,{render_subset:true,count:y-2})});}else if(ba.length==3){ca=s._("{participant1}, {participant2}, {participant3}",{participant1:ba[0],participant2:ba[1],participant3:ba[2]});}else ca=s._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:ba[0],participant2:ba[1],participant3:ba[2],others_link:this.renderRawParticipantCount(w,{render_subset:true,count:y-3})});if(Array.isArray(ca))ca=i.create('span',{},ca);return ca;},renderRawTitleWithUnreadCount:function(w,x){var y=w;if(x&&x>1)y=i.create('span',{},s._("{conversation_title} ({unread_count})",{conversation_title:w,unread_count:x}));return y;},renderRawParticipantCount:function(w,x){var y=x.render_subset,z;if(!y){z=x.count>1?s._("{num} people",{num:x.count}):"1 person";}else z=x.count>1?s._("{others_count} others",{others_count:x.count}):"1 other";return z;},renderShortNames:function(w){if(w.length==1)return [w[0].name];return w.map(function(x){return x.short_name;});},getUserCanonicalWebMessengerURL:function(w,x,y){var z=new o(q.uri),aa=w.substr(w.indexOf(':')+1);z.setPath(v(y)+'/'+aa);x&&x(z.toString());return z.toString();},getWebMessengerURLWithServerID:function(w,x,y){var z=new o(q.uri);z.setPath(p.getURIPathForThreadID(w,v(y)));x&&x(z.toString());return z.toString();},renderUserCanonicalWebMessengerLink:function(w,x,y,z){var aa=this.getUserCanonicalWebMessengerURL(w,null,z);x.setAttribute('href',aa);y&&y();},renderWebMessengerLinkWithServerID:function(w,x,y,z){var aa=this.getWebMessengerURLWithServerID(w,null,z);x.setAttribute('href',aa);y&&y();},renderStatusIndicator:function(w,x,y){var z;if(w==j.RESENDING){z=this.renderResendIndicator();}else if(w!==undefined&&w!=j.UNSENT&&w!=j.UNCONFIRMED&&w!=j.SUCCESS)z=this.renderErrorIndicator(x,y);return z;},renderResendIndicator:function(){return m[':fb:mercury:resend-indicator'].render();},renderErrorIndicator:function(w,x){if(!w)return null;var y=m[':fb:mercury:error-indicator'].render(),z=w.is_transient,aa=k.getMessage(w);if(z)if(k.isConnectionError(w)){aa=t._("{message} Check your internet connection and click to try again.",[t.param("message",aa)]);}else aa=t._("{message} Click to send again.",[t.param("message",aa)]);n.set(y,aa,'above','center');if(x&&z){g.listen(y,'click',x);y.setAttribute('tabindex','0');h.addClass(y,"_55q-");}return y;},_cloneIfDOMElement:function(w){if(w&&w.cloneNode){return w.cloneNode();}else return w;}};function v(w){var x=p.BASE_PATH;if(w&&w!=l.INBOX)x+='/'+w;return x;}e.exports=u;},null);
__d("MercurySeenByAll",["CSS","DataStore","DOM","MercuryParticipants","MercuryDelayedRoger","MercuryThreads"],function(a,b,c,d,e,f,g,h,i,j,k){var l=b('MercuryThreads').get(),m={},n={updateOnSeenChange:function(p,q,r){m[p.tagName]=true;h.set(p,'thread-id',q.thread_id);g.addClass(p,'seenByListener');o(p,q,r);}};function o(p,q,r){var s=null;if(r){s=j.getIDFromVanityOrFBID(r);}else s=j.user;var t=q.participants.filter(function(v){return v!==s;}),u=q.participants.length>0&&q.participants[0]===s;g.conditionClass(p,'repliedLast',u);g.conditionClass(p,'seenByAll',u&&k.getSeenBy(q.thread_id).length===t.length);}k.subscribe('state-changed',function(p,q){for(var r in m){var s=i.scry(document.body,r+'.seenByListener');for(var t=0;t<s.length;t++){var u=s[t],v=h.get(u,'thread-id');if(q[v])l.getThreadMeta(v,function(w){o(u,w);});}}});e.exports=n;},null);
__d("MercuryThreadMetadataRenderer",["CSS","DOM","Emoji","EmoticonsList","HTML","JSLogger","MercuryAttachment","MercuryAttachmentType","MercuryConstants","MercuryMessageSourceTags","MercurySingletonMixin","MercuryThreadImage.react","MercuryThreadMetadataRawRenderer","MercuryParticipants","React","MercurySeenByAll","MercuryServerRequests","StickerConstants","Style","MercuryThreadlistIconTemplates","MercuryThreads","Tooltip","URI","arrayContains","createArrayFrom","copyProperties","cx","emojiAndEmote","fbt","formatDate","tx","OrionMercuryAttachmentStrings"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka){var la=b('OrionMercuryAttachmentStrings').module,ma=l.create('wm_timestamp');function na(ua){this._fbid=ua;this._serverRequests=w.getForFBID(ua);this._threads=aa.getForFBID(ua);}fa(na,q);fa(na.prototype,{renderTimestamp:function(ua,va,wa,xa){if(xa){if(!va){ma.warn('no_title');va=(new Date(xa)).toLocaleDateString();}ua.setAttribute('title',va);ua.setAttribute('data-utime',xa/1000);if(!wa){ma.warn('no_display');wa=ja(new Date(xa),'g:ia');}h.setContent(ua,wa);g.show(ua);}},renderMessageSourceTags:function(ua,va,wa,xa){var ya='',za='',ab='';if(da(wa,p.MESSENGER)){ya="Sent from Messenger";za=new ca('/mobile/messenger');ab="_9g";}else if(da(wa,p.MOBILE)){ya="Sent from Mobile";za=new ca('/mobile/');ab="_9j";}else if(da(wa,p.CHAT)){ya="Sent from chat";ab="_9h";}else if(da(wa,p.EMAIL)){if(xa){ya=ka._("Sent from {email}",{email:xa});}else ya="Sent from email";ab="_9i";}if(ab){ba.set(ua,ya);g.addClass(va,ab);if(za){ua.setAttribute('href',za);}else ua.removeAttribute('href');}else g.hide(ua);},renderMessageLocation:function(ua,va,wa){var xa=ca('/ajax/messaging/hovercard/map.php').setQueryData(wa);ua.setAttribute('data-hovercard',xa);g.removeClass(ua,"_b9");g.show(va);},renderSpoofWarning:function(ua,va,wa){if(va){g.addClass(ua,"_sa");ba.set(ua,ka._("Unable to confirm {name_or_email} as the sender.",{name_or_email:wa.name}));}},renderChatSpoofWarning:function(ua,va,wa){if(va)h.appendContent(ua,ka._("Unable to confirm {name_or_email} as the sender.",{name_or_email:wa.name}));},renderCoreThreadlist:function(ua,va,wa,xa,ya){xa=xa||{};this.renderThreadImage(ua,va.getNode('image'));var za=va.getNode('accessibleName'),ab=[va.getNode('name')];if(za)ab.push(za);ta(this,ua,ab,xa);if(ua.folder&&ya)sa(va.getNode('folderBadge'),ua.folder);var bb=va.getNode('timestamp');this.renderTimestamp(bb,ua.timestamp_absolute,ua.timestamp_relative,ua.timestamp);this.renderSnippet(ua,va.getNode('snippet'));pa(va,ua);wa(va,ua);},renderAndSeparatedParticipantList:function(ua,va,wa){wa=wa||{};wa.last_separator_uses_and=true;this._threads.getThreadMeta(ua,function(xa){ta(this,xa,va,wa);}.bind(this));},renderSnippet:function(ua,va){var wa=false,xa=h.create('span');g.addClass(xa,'MercuryRepliedIndicator');h.appendContent(va,xa);v.updateOnSeenChange(xa,ua,this._fbid);var ya=ua.snippet;if(ya){if(ua.snippet_has_attachment)h.appendContent(va,h.create('span',{className:'MercuryAttachmentIndicator'}));if(ua.is_forwarded_snippet)h.appendContent(va,h.create('strong',{className:"_55q_"},"Forwarded Message:"));if(ya.substr(0,4)=='?OTR'){ya="[encrypted message]";}else ya=ya.replace(/\r\n|[\r\n]/g," ");ya=k(i.htmlEmojiAndEmote(ya));}else{if(ua.is_forwarded_snippet)h.appendContent(va,h.create('strong',{className:"_55q_"},"Forwarded Message"));if(ua.snippet_has_attachment&&ua.snippet_attachments&&ua.snippet_attachments.length){wa=true;ya=h.create('span');ra(this,ua,ya);}}var za=ua.participants.length;if(ua.is_subscribed)za--;if(!wa&&ua.snippet_sender&&t.getIDForUser(this._fbid)!=ua.snippet_sender&&za>1){t.get(ua.snippet_sender,function(ab){if(ab.short_name){h.appendContent(va,ka._("{name}: {conversation_snippet}",{name:ab.short_name,conversation_snippet:ya}));}else h.appendContent(va,ya);});}else h.appendContent(va,ya);},getWebMessengerURL:function(ua,va,wa){if(ua.substr(0,ua.indexOf(':'))=='user'){s.getUserCanonicalWebMessengerURL(ua,va,wa);}else this._serverRequests.getServerThreadID(ua,function(xa){s.getWebMessengerURLWithServerID(xa,va,wa);});},renderWebMessengerLink:function(ua,va,wa,xa){if(ua.substr(0,ua.indexOf(':'))=='user'){s.renderUserCanonicalWebMessengerLink(ua,va,wa,xa);}else this._serverRequests.getServerThreadID(ua,function(ya){s.renderWebMessengerLinkWithServerID(ya,va,wa,xa);});},renderThreadImage:function(ua,va){u.renderComponent(u.createElement(r,{thread:ua,viewer:this._fbid}),va);},renderParticipantList:function(ua,va,wa,xa){return s.renderRawParticipantList(this._serverRequests.getServerThreadIDNow(ua),va,wa,xa);},renderThreadNameAndParticipantList:function(ua,va,wa,xa){var ya=s.renderRawParticipantList(this._serverRequests.getServerThreadIDNow(ua),va,wa,xa),za=this._threads.getThreadMetaNow(ua);if(!za.name)return ya;return ka._("{conversation_name} [with {participant_list}]",{conversation_name:za.name,participant_list:ya});},renderParticipantCount:function(ua,va){return s.renderRawParticipantCount(this._serverRequests.getServerThreadIDNow(ua),va);}});function oa(ua){if(!ua.snippet_attachments)return [];return ua.snippet_attachments.filter(function(va){return va.attach_type===n.PHOTO;});}function pa(ua,va){var wa=oa(va);if(wa.length===0)return;var xa=wa[0].thumbnail_url;if(!xa)return;var ya=(wa.length==1)?'snippet-thumbnail-single':'snippet-thumbnail-multiple',za=ua.getNode(ya);if(!za)return;var ab=h.find(za,'i');y.set(ab,'background-image','url('+xa+')');g.show(za);}function qa(ua){return ua==x.LIKE_STICKER_ID||ua==x.HOT_LIKE_SMALL_STICKER_ID||ua==x.HOT_LIKE_MEDIUM_STICKER_ID||ua==x.HOT_LIKE_LARGE_STICKER_ID;}function ra(ua,va,wa){var xa=va.snippet_sender&&t.getIDForUser(ua._fbid)==va.snippet_sender,ya=function(hb){if(!va.snippet_sender||xa){hb(null);return;}t.get(va.snippet_sender,function(ib){hb(ib.short_name);});},za=o.MercurySupportedShareType.FB_ORION,ab=oa(va),bb=ab.length==va.snippet_attachments.length,cb=va.snippet_attachments.length===1&&va.snippet_attachments[0].attach_type===n.VIDEO,db=va.snippet_attachments.length===1&&va.snippet_attachments[0].metadata&&va.snippet_attachments[0].metadata.type=='fb_voice_message',eb=va.snippet_attachments.length===1&&va.snippet_attachments[0].attach_type===n.STICKER,fb=va.snippet_attachments.length===1&&va.snippet_attachments[0].attach_type===n.SHARE,gb=va.snippet_attachments.length===1&&va.snippet_attachments[0].share_data_type===za;ya(function(hb){var ib=null;if(bb){var jb=z[':fb:mercury:attachment-icon-text'].build().getRoot();if(ab.length===1){ib=xa?"You sent a photo.":ka._("{name} sent a photo.",{name:hb});}else ib=xa?ka._("You sent {num_photos} photos.",{num_photos:ab.length}):ka._("{name} sent {num_photos} photos.",{name:hb,num_photos:ab.length});g.addClass(jb,m.getAttachIconClass(ab[0].icon_type));h.appendContent(jb,ib);h.appendContent(wa,jb);}else if(cb){var kb=z[':fb:mercury:attachment-icon-text'].build().getRoot();if(xa){ib="You sent a video.";}else ib=ia._("{sender name} sent a video.",[ia.param("sender name",hb)]);g.addClass(kb,m.getAttachIconClass(va.snippet_attachments[0].icon_type));h.appendContent(kb,ib);h.appendContent(wa,kb);}else if(db){var lb=z[':fb:mercury:attachment-icon-text'].build().getRoot();ib=xa?"You sent a voice message.":ka._("{name} sent a voice message.",{name:hb});g.addClass(lb,m.getAttachIconClass(va.snippet_attachments[0].icon_type));h.appendContent(lb,ib);h.appendContent(wa,lb);}else if(eb){if(qa(va.snippet_attachments[0].metadata.stickerID)){ib=ha(j.symbols.like);}else ib=xa?"You sent a sticker.":ka._("{name} sent a sticker.",{name:hb});h.appendContent(wa,ib);}else if(gb){var mb=z[':fb:mercury:attachment-icon-text'].build().getRoot();ib=la.getOrionMercuryThreadAttachmentMetadataText(xa,hb);g.addClass(mb,m.getAttachIconClass(va.snippet_attachments[0].icon_type));h.appendContent(mb,ib);h.appendContent(wa,mb);}else if(fb){var nb=z[':fb:mercury:attachment-icon-text'].build().getRoot();if(xa){ib="You shared a link.";}else ib=ia._("{sender name} shared a link.",[ia.param("sender name",hb)]);g.addClass(nb,m.getAttachIconClass(va.snippet_attachments[0].icon_type));h.appendContent(nb,ib);h.appendContent(wa,nb);}else va.snippet_attachments.filter(function(ob){return ob.attach_type===n.FILE||ob.attach_type===n.PHOTO||ob.attach_type===n.VIDEO;}).forEach(function(ob){var pb=z[':fb:mercury:attachment-icon-text'].build().getRoot();h.appendContent(pb,ob.name);g.addClass(pb,m.getAttachIconClass(ob.icon_type));h.appendContent(wa,pb);});});}function sa(ua,va){ea(ua).forEach(function(wa){h.setContent(wa,va);});}function ta(ua,va,wa,xa){wa=ea(wa);if(va.name){var ya=s.renderRawTitleWithUnreadCount(va.name,xa.show_unread_count?va.unread_count:0);wa.forEach(function(ab){h.setContent(ab,ya);});xa.callback&&xa.callback(ya);return;}var za=va.participants;if(va.participants.length>1)za=va.participants.filter(function(ab){return ab!=t.getIDForUser(ua._fbid);});t.getMulti(za,function(ab){s.renderParticipantListWithNoThreadName(ua._serverRequests.getServerThreadIDNow(va.thread_id),va,za,ab,wa,xa);});}e.exports=na;},null);
__d("AsyncLayout",["AjaxPipeRequest","Arbiter","AsyncRequest","AsyncResponse","CSS","DOM","HTML","NavigationMessage","PageTransitions","URI","$","emptyFunction","ge","goURI"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){function u(v){"use strict";this.canvasID=v;if(s('rightCol'))this.auxiliaryID='rightCol';if(s('headerArea'))this.headerID='headerArea';if(s('toolbarContainer'))this.toolbarID='toolbarContainer';this.waitingForAux=false;o.registerHandler(this.catchPageTransition.bind(this));this.subscription=h.subscribe(n.NAVIGATION_BEGIN,this.onNavigate.bind(this));h.inform('AsyncLayout/initialized',null,h.BEHAVIOR_STATE);}u.prototype.catchPageTransition=function(v){"use strict";this.subscription.unsubscribe();return false;};u.prototype.getCanvasID=function(v){"use strict";return v.sidecol?'contentCol':'contentArea';};u.prototype.onNavigate=function(v,w){"use strict";var x=w.useAjaxPipe;w=w.params;if(w.endpoint){if(this.request){this.request.setFinallyHandler(r);this.request.abort();}if(this.sideRequest)this.sideRequest.abort();if(x){this.request=new g().setURI(w.endpoint).setData(w).setCanvasId(this.getCanvasID(w)).setFinallyHandler(this.finallyHandler.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFirstResponseCallback(this.firstResponseCallback.bind(this)).send();}else{w.handled=true;this.waitingForAux=w.sidecol;var y=!!w.iframe,z=new i().setOption('useIframeTransport',y).setURI(new p(w.endpoint)).setReadOnly(true).setMethod('GET').setData(w).setHandler(this.onResponse.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFinallyHandler(this.finallyHandler.bind(this));this.request=z;z.send();}}};u.prototype.onSideResponse=function(v){"use strict";var w=v.getPayload();if(w&&this.auxiliaryID)this.receivedAux(w);};u.prototype.receivedAux=function(v){"use strict";!this.waitingForAux;this.waitingForAux=false;l.setContent(q(this.auxiliaryID),m(v));};u.prototype.onResponse=function(v){"use strict";var w=v.getPayload();if(w.redirect){t(w.redirect);}else{var x=w.html||w;l.setContent(q(this.canvasID),m(x));if(w.side_html&&this.auxiliaryID)this.receivedAux(w.side_html);if(this.headerID&&!w.keep_header){var y=q(this.headerID);l.setContent(y,m(w.header_html||''));k.conditionShow(y,w.header_html);}if(w.toolbar_html&&this.toolbarID)l.setContent(q(this.toolbarID),m(w.toolbar_html));if(w.js)(new Function(w.js))();k.conditionClass('contentCol','hasRightCol',this.auxiliaryID&&!w.noRightSide);var z=s('rightCol');if(z&&w.noRightSide)l.empty(z);}var aa=v.getRequest().getData();h.inform(n.NAVIGATION_COMPLETED,aa.key);};u.prototype.errorHandler=function(v){"use strict";j.verboseErrorHandler(v);h.inform(n.NAVIGATION_FAILED);this.request=null;};u.prototype.firstResponseCallback=function(v){"use strict";window.scrollTo(0,0);h.inform(n.NAVIGATION_FIRST_RESPONSE);};u.prototype.finallyHandler=function(v){"use strict";this.request=null;o.transitionComplete(true);h.inform(n.NAVIGATION_COMPLETED);};e.exports=u;},null);
__d("legacy:adware-scanner",["AdwareScaner"],function(a,b,c,d){a.AdwareScaner=b('AdwareScaner');},3);